<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quest of Elements - Grand Master</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        :root {
            --bg-color: #101010; --win-bg: rgba(0,0,0,0.95); --win-border: #fff;
            --text-color: #fff; --accent: #ffd700; --danger: #ff4444; --warn: #ffff44; --mp: #4488ff;
            --rare-n: #a0a0a0; --rare-r: #40e040; --rare-sr: #40e0e0; --rare-ur: #e040e0; --rare-ex: #ffff00;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            background: var(--bg-color); color: var(--text-color);
            font-family: 'DotGothic16', sans-serif;
            margin: 0; padding: 0; overflow: hidden;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            user-select: none; -webkit-user-select: none;
        }
        #game-container {
            position: relative; width: 100%; max-width: 600px; height: 100%; max-height: 900px;
            background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        #canvas-wrapper { flex: 1; position: relative; overflow: hidden; border-bottom: 2px solid #fff; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        .dialog-box {
            background: var(--win-bg); border: 2px solid var(--win-border); border-radius: 4px;
            padding: 8px; margin: 5px; pointer-events: auto; font-size: 14px; line-height: 1.4;
        }
        .full-screen-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; pointer-events: auto; overflow-y: auto;
        }
        
        .btn {
            background: #333; border: 2px solid #666; color: #fff; padding: 10px;
            font-family: inherit; font-size: 14px; cursor: pointer; text-align: center;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: #555; transform: translateY(2px); }
        .btn-menu { width: 100%; margin-bottom: 8px; justify-content: space-between; }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 10px; }
        .item-row { border-bottom: 1px solid #444; padding: 8px 5px; cursor: pointer; display: flex; align-items: center;}
        .item-row:hover { background: #222; }
        .item-row.selected { background: #333; border: 1px solid var(--accent); }
        
        .stat-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 5px; }
        .stat-table td { border-bottom: 1px dotted #444; padding: 4px 2px; }
        
        /* Status Tabs */
        .tab-header { display: flex; border-bottom: 1px solid #fff; }
        .tab-btn { flex: 1; padding: 10px 0; text-align: center; background: #222; cursor: pointer; border-right: 1px solid #444; font-size: 12px; }
        .tab-btn.active { background: #555; color: var(--accent); font-weight: bold; }
        .tab-content { display: none; padding: 10px; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        
        .profile-img { width: 80px; height: 80px; background: #333; border: 2px solid #fff; object-fit: cover; display: block; margin-bottom: 10px; }
        .list-thumb { width: 40px; height: 40px; background: #333; border: 1px solid #fff; margin-right: 10px; flex-shrink: 0; display:flex; align-items:center; justify-content:center; font-size:8px; color:#888;}
        .no-img { display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px; }
        
        .rarity-N { color: var(--rare-n); } .rarity-R { color: var(--rare-r); }
        .rarity-SR { color: var(--rare-sr); } .rarity-UR { color: var(--rare-ur); }
        .rarity-EX { color: var(--rare-ex); font-weight: bold; text-shadow: 0 0 5px yellow; }

        /* Battle */
        #battle-ui { display: none; flex-direction: column; height: 100%; padding: 5px; }
        #battle-scene { flex: 1; position: relative; display: flex; justify-content: space-around; align-items: center; align-content: center; flex-wrap: wrap; }
        .enemy-sprite { 
            width: 70px; height: 70px; background-size: cover; border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            margin: 2px; position: relative; transition: 0.2s;
        }
        .enemy-sprite.dead { opacity: 0; transform: scale(0.5); }
        .enemy-hp-bar { width: 100%; height: 4px; background: #333; margin-top: 2px; }
        .enemy-hp-val { height: 100%; background: var(--danger); transition: 0.2s; }
        
        #battle-log { flex: 1; overflow-y: auto; font-size: 12px; border: 1px solid #444; padding: 5px; background: rgba(0,0,0,0.5); margin-bottom: 5px; min-height: 80px;}
        #battle-cmd-root, #battle-cmd-sub { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; height: 60px; }
        
        /* Battle Status */
        #party-status-container { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 2px; background:#222; padding:2px; font-size:10px; text-align:center;}
        .p-stat-box { border: 1px solid #444; padding: 4px 2px; height: 70px; display: flex; flex-direction: column; justify-content: space-around; transition: color 0.2s; }
        .p-dead { color: var(--danger); border-color: var(--danger); background: #200; }
        .p-warn { color: var(--warn); }
        
        #auto-btn { position: absolute; top: 10px; right: 10px; width: 60px; height: 30px; font-size: 12px; z-index: 50; background: #400; opacity: 0.8; }
        #auto-btn.on { background: #d00; border-color: #f88; opacity: 1; box-shadow: 0 0 10px red; }

        #controls { height: 160px; background: #222; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .dpad { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px 50px; gap: 2px; }
        .d-up { grid-column: 2; grid-row: 1; } .d-left { grid-column: 1; grid-row: 2; }
        .d-right { grid-column: 3; grid-row: 2; } .d-down { grid-column: 2; grid-row: 3; }
        .action-pad { display: flex; flex-direction: column; gap: 10px; width: 100px; }
        
        .damage-pop { position: absolute; color: #fff; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000; animation: floatUp 0.8s forwards; pointer-events: none; z-index: 10; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Gacha Animation */
        #gacha-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 300;
            background: #000; display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .gacha-flash {
            width: 10px; height: 10px; border-radius: 50%; background: #fff;
            box-shadow: 0 0 20px 10px #fff;
            animation: flashAnim 1s forwards;
        }
        @keyframes flashAnim {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(50); opacity: 1; }
            100% { transform: scale(200); opacity: 0; }
        }
        @keyframes rainbow { 
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .rainbow-bg {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
        }
        
        /* Menu Bottom Status */
        #menu-party-status {
            background: #1a1a1a; border-top: 1px solid #fff; padding: 5px;
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 2px;
            font-size: 9px; text-align: center;
        }
        .mp-bar { width: 100%; height: 3px; background: #444; margin-top: 2px; }
        .mp-val { height: 100%; background: var(--mp); }

        /* Footer Desc */
        #sub-footer {
            border-top: 1px solid #fff; padding: 10px; font-size: 12px;
            background: #222; color: #ccc; min-height: 50px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="320" height="320"></canvas>
        <div class="ui-layer" id="field-ui">
            <div class="dialog-box" style="width: fit-content; border:none; background:none; text-shadow:1px 1px 0 #000;">
                <span id="loc-name">フィールド</span> <br>
            </div>
            <div class="dialog-box" id="msg-box" style="margin-top:auto; height:80px;">冒険の始まりだ。</div>
        </div>
    </div>

    <!-- Battle Overlay -->
    <div id="battle-ui" class="full-screen-modal" style="background:rgba(0,0,0,1);">
        <button id="auto-btn" class="btn" onclick="Battle.toggleAuto()">AUTO:OFF</button>
        <div id="battle-scene"></div>
        <div id="party-status-container">
            <div id="p-stat-1" class="p-stat-box"></div><div id="p-stat-2" class="p-stat-box"></div>
            <div id="p-stat-3" class="p-stat-box"></div><div id="p-stat-4" class="p-stat-box"></div>
        </div>
        <div id="battle-info" style="height: 180px; display: flex; flex-direction: column;">
            <div id="battle-log"></div>
            <div id="battle-cmd-root">
                <button class="btn" onclick="Battle.onFight()">たたかう</button>
                <button class="btn" onclick="Battle.onRun()">にげる</button>
            </div>
            <div id="battle-cmd-sub" style="display:none; grid-template-columns: 1fr 1fr 1fr; height: 100px;">
                <button class="btn" onclick="Battle.selectAction('attack')">攻撃</button>
                <button class="btn" onclick="Battle.openSkillList('magic')">魔法</button>
                <button class="btn" onclick="Battle.openSkillList('skill')">特技</button>
                <button class="btn" onclick="Battle.openItemList()">道具</button>
                <button class="btn" onclick="Battle.selectAction('guard')">防御</button>
                <button class="btn" style="background:#502020;" onclick="Battle.backToRoot()">戻る</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="dpad">
            <button class="btn d-up" id="btn-up">▲</button>
            <button class="btn d-left" id="btn-left">◀</button>
            <button class="btn d-right" id="btn-right">▶</button>
            <button class="btn d-down" id="btn-down">▼</button>
        </div>
        <div class="action-pad">
            <button class="btn" style="height:50px; background:#404080;" onclick="UI.openMenu()">MENU</button>
            <button class="btn" style="height:50px;" id="btn-ok" onclick="UI.onOk()">決定</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="start-screen" class="full-screen-modal" style="display:flex; justify-content:center; align-items:center;">
        <h1 style="color:var(--accent);">QUEST OF ELEMENTS</h1>
        <p>名前を入力</p>
        <input type="text" id="input-name" placeholder="名前" value="勇者" style="padding:10px; font-size:16px; margin-bottom:10px;">
        <p>画像(任意)</p>
        <input type="file" id="input-file" accept="image/*" style="margin-bottom:20px;">
        <button class="btn" style="width:200px; padding:15px;" onclick="Game.start()">START</button>
    </div>

    <div id="menu-screen" class="full-screen-modal" style="display:none; flex-direction:column;">
        <div style="padding:10px; display:flex; justify-content:space-between; border-bottom:1px solid #fff; align-items:center;">
            <span style="font-size:12px;">G:<span id="menu-gold"></span> GEM:<span id="menu-gem"></span></span>
            <button class="btn" style="width:60px;" onclick="UI.closeMenu()">閉じる</button>
        </div>
        <div class="scroll-area" style="flex:1;">
            <button class="btn btn-menu" style="background:#400040;" onclick="Dungeon.enter()">ダンジョンへ</button>
            <div class="list-grid">
                <button class="btn" onclick="UI.showStatusList()">ステータス</button>
                <button class="btn" onclick="UI.showEquip()">装備変更</button>
                <button class="btn" onclick="UI.showItems()">道具使用</button>
                <button class="btn" onclick="UI.showPartyForm()">編成</button>
                <button class="btn" onclick="UI.showCharList()">仲間一覧(強化)</button>
                <button class="btn" onclick="UI.showMonsterBook()">魔物図鑑</button>
                <button class="btn" onclick="UI.showGacha()">ガチャ</button>
            </div>
        </div>
        <div id="menu-party-status"></div>
    </div>
    
    <div id="sub-screen" class="full-screen-modal" style="background:rgba(0,0,0,0.95); z-index:110;">
        <div style="padding:10px; display:flex; justify-content:space-between; border-bottom:1px solid #fff;">
            <h3 id="sub-title" style="margin:0;">Title</h3>
            <button class="btn" style="width:60px;" onclick="document.getElementById('sub-screen').style.display='none'">戻る</button>
        </div>
        <div id="sub-content" class="scroll-area"></div>
        <div id="sub-footer"></div>
    </div>
    
    <!-- List Modal -->
    <div id="list-modal" class="full-screen-modal" style="background:rgba(0,0,0,0.85); z-index:200;">
        <div class="dialog-box" style="margin:20px; height:80%; display:flex; flex-direction:column;">
            <h3 id="list-title" style="margin:0 0 10px 0;">選択</h3>
            <div id="list-container" class="scroll-area"></div>
            <div id="list-desc" style="min-height:40px; border-top:1px solid #555; font-size:12px; padding:5px; color:#aaa;"></div>
            <button class="btn" style="margin-top:10px;" onclick="UI.closeList()">キャンセル</button>
        </div>
    </div>

    <!-- Gacha Effect -->
    <div id="gacha-overlay">
        <div class="gacha-flash"></div>
    </div>
</div>

<script>
/* ==========================================================================
   MASTER DATA
   ========================================================================== */
const CONST = {
    ELEMENTS: ['火', '水', '風', '雷', '光', '闇', '混沌'],
    PARTS: ['武器', '盾', '頭', '体', '足'],
    TYPE_SKILLS: {
        '物理': { 1:['強打'], 5:['兜割り'], 10:['五月雨突き'], 20:['魔神斬り'], 30:['覇王の一閃'], 50:['ギガブレイク'] },
        '魔法': { 1:['メラ'], 5:['ヒャド'], 10:['イオ'], 15:['バイキルト'], 20:['メラゾーマ'], 30:['メラガイアー'], 40:['イオナズン'] },
        '回復': { 1:['ホイミ'], 5:['スカラ'], 12:['ベホイミ'], 20:['ザオラル'], 30:['ベホマラー'], 40:['ザオリク'] },
        '特殊': { 1:['石つぶて'], 10:['口笛'], 20:['パルプンテ'], 30:['いてつく波動'] }
    }
};

const DB = {
    SKILLS: [
        {id:1, name:'こうげき', type:'物理', target:'単体', mp:0, desc:'武器による直接攻撃'},
        {id:2, name:'強打', type:'物理', target:'単体', mp:2, rate:1.2, count:1, base:5, desc:'力を込めた強力な一撃'},
        {id:3, name:'火炎斬り', type:'物理', target:'単体', mp:4, elm:'火', rate:1.3, count:1, base:10, desc:'炎をまとった剣技'},
        {id:4, name:'兜割り', type:'物理', target:'単体', mp:4, rate:1.1, count:1, base:0, desc:'攻撃と同時に守備力を下げる'},
        {id:5, name:'五月雨突き', type:'物理', target:'ランダム', mp:8, rate:0.5, count:4, base:0, desc:'ランダムな敵に4回攻撃'},
        {id:6, name:'魔神斬り', type:'物理', target:'単体', mp:12, rate:2.5, count:1, base:0, desc:'ミスしやすいが当たれば会心'},
        {id:7, name:'ギガデイン', type:'魔法', target:'全体', mp:30, elm:'雷', rate:1.0, count:1, base:150, desc:'敵全体を雷光で焼き尽くす'},
        {id:8, name:'ギガブレイク', type:'物理', target:'単体', mp:25, elm:'雷', rate:2.5, count:1, base:100, desc:'雷の力を宿した究極剣技'},
        {id:10, name:'メラ', type:'魔法', target:'単体', mp:2, elm:'火', rate:1.0, count:1, base:15, desc:'小さな火の玉を放つ'},
        {id:13, name:'メラゾーマ', type:'魔法', target:'単体', mp:15, elm:'火', rate:1.0, count:1, base:100, desc:'巨大な火球で焼き尽くす'},
        {id:14, name:'メラガイアー', type:'魔法', target:'単体', mp:45, elm:'火', rate:1.0, count:1, base:300, desc:'全てを灰にする地獄の業火'},
        {id:15, name:'ヒャド', type:'魔法', target:'単体', mp:3, elm:'水', rate:1.0, count:1, base:20, desc:'氷の刃で切り裂く'},
        {id:16, name:'イオ', type:'魔法', target:'全体', mp:8, elm:'光', rate:0.8, count:1, base:25, desc:'爆発で敵全体を攻撃'},
        {id:17, name:'イオナズン', type:'魔法', target:'全体', mp:25, elm:'光', rate:1.0, count:1, base:120, desc:'大爆発で敵全体を攻撃'},
        {id:20, name:'ホイミ', type:'回復', target:'単体', mp:3, rate:0.5, count:1, base:30, desc:'仲間のHPを少し回復'},
        {id:21, name:'ベホイミ', type:'回復', target:'単体', mp:6, rate:1.0, count:1, base:80, desc:'仲間のHPを中回復'},
        {id:22, name:'ベホマラー', type:'回復', target:'全体', mp:18, rate:0.8, count:1, base:100, desc:'味方全員のHPを回復'},
        {id:30, name:'ザオラル', type:'蘇生', target:'単体', mp:10, rate:0.5, count:1, base:0, desc:'50%の確率で仲間を生き返らせる'},
        {id:31, name:'ザオリク', type:'蘇生', target:'単体', mp:30, rate:1.0, count:1, base:0, desc:'仲間を確実に生き返らせる'},
        {id:40, name:'バイキルト', type:'強化', target:'単体', mp:8, buff:{atk:1.5}, desc:'攻撃力を一時的に1.5倍にする'},
        {id:41, name:'スカラ', type:'強化', target:'単体', mp:4, buff:{def:1.5}, desc:'守備力を一時的に1.5倍にする'},
        {id:99, name:'石つぶて', type:'物理', target:'全体', mp:0, rate:0.5, count:1, base:5, desc:'敵全体に小石を投げる'}
    ],
    ITEMS: [
        {id:1, name:'やくそう', type:'HP回復', val:400, desc:'HPを300～500回復'},
        {id:2, name:'上やくそう', type:'HP回復', val:1000, desc:'HPを800～1200回復'},
        {id:3, name:'特やくそう', type:'HP回復', val:3000, desc:'HPを2800～3500回復'},
        {id:4, name:'世界樹の雫', type:'HP回復', val:9999, desc:'味方全体のHPを全回復', target:'全体'},
        {id:5, name:'魔法の小瓶', type:'MP回復', val:100, desc:'MPを80～120回復'},
        {id:6, name:'魔法の聖水', type:'MP回復', val:500, desc:'MPを400～600回復'},
        {id:7, name:'賢者の聖水', type:'MP回復', val:2000, desc:'MPを1800～2000回復'},
        {id:8, name:'エルフの飲み薬', type:'MP回復', val:9999, desc:'MPを全回復'}
    ],
    CHARACTERS: [
        {id:1, job:'魔法剣士', name:'菊田 航平', rarity:'SR', type:'特殊', hp:100, mp:45, atk:55, mag:43, def:37, spd:14},
        {id:2, job:'戦士', name:'菅 裕輝', rarity:'SR', type:'物理', hp:69, mp:18, atk:38, mag:12, def:27, spd:9},
        {id:3, job:'海賊', name:'吉澤 明', rarity:'UR', type:'特殊', hp:142, mp:64, atk:66, mag:50, def:20, spd:24},
        {id:4, job:'僧侶', name:'大西 亮', rarity:'SR', type:'回復', hp:73, mp:63, atk:43, mag:46, def:32, spd:14},
        {id:5, job:'魔法使い', name:'小林 剛', rarity:'SR', type:'魔法', hp:70, mp:44, atk:24, mag:43, def:14, spd:19},
        {id:6, job:'軍師', name:'福永 昭', rarity:'UR', type:'特殊', hp:100, mp:78, atk:72, mag:42, def:32, spd:16},
        {id:7, job:'魔法使い', name:'吉清 雅紀', rarity:'SR', type:'魔法', hp:61, mp:62, atk:26, mag:50, def:16, spd:15},
        {id:8, job:'魔法使い', name:'市塚 光太', rarity:'SR', type:'魔法', hp:56, mp:48, atk:28, mag:45, def:15, spd:21},
        {id:9, job:'僧侶', name:'石月 芙実', rarity:'SR', type:'回復', hp:63, mp:56, atk:42, mag:39, def:19, spd:10},
        {id:10, job:'僧侶', name:'山田 友理香', rarity:'SR', type:'回復', hp:68, mp:48, atk:33, mag:39, def:20, spd:12}
    ],
    MONSTERS: [
        {id:1, name:'スライム', hp:8, mp:0, atk:8, mag:0, def:2, spd:3, exp:10, gold:10, gem:30, dropRate:24, acts:[1], minF:1, maxF:3},
        {id:2, name:'おおがらす', hp:36, mp:0, atk:28, mag:0, def:20, spd:10, exp:20, gold:20, gem:50, dropRate:10, acts:[1], minF:2, maxF:5},
        {id:3, name:'ドラキー', hp:25, mp:5, atk:20, mag:5, def:10, spd:15, exp:15, gold:15, gem:40, dropRate:15, acts:[1,10], minF:1, maxF:4},
        {id:4, name:'ゴースト', hp:40, mp:15, atk:25, mag:20, def:30, spd:12, exp:25, gold:25, gem:50, dropRate:15, acts:[1,10], minF:3, maxF:6},
        {id:5, name:'オーク', hp:100, mp:0, atk:50, mag:0, def:30, spd:10, exp:50, gold:50, gem:80, dropRate:20, acts:[1,2], minF:5, maxF:10},
        {id:6, name:'キラーマシン', hp:250, mp:0, atk:90, mag:0, def:80, spd:30, exp:150, gold:100, gem:150, dropRate:30, acts:[1,5,6], minF:10, maxF:20},
        {id:10, name:'ドラゴン', hp:400, mp:50, atk:80, mag:20, def:60, spd:25, exp:200, gold:150, gem:30, dropRate:50, acts:[1,2,100], minF:10, maxF:100},
        {id:11, name:'魔王の影', hp:800, mp:100, atk:120, mag:80, def:80, spd:40, exp:1000, gold:500, gem:100, dropRate:80, acts:[1,2,6], minF:20, maxF:100},
        {id:26, name:'Gスライム', hp:2000, mp:9999, atk:500, mag:2000, def:5000, spd:1999, exp:100000, gold:100000, gem:30000, dropRate:100, acts:[1,10,13,14,7], minF:30, maxF:100}
    ],
    EQUIPS: [
        {id:1, name:'どうのつるぎ', type:'武器', atk:15, val:1000},
        {id:2, name:'はがねのつるぎ', type:'武器', atk:30, val:10000},
        {id:3, name:'ロトのつるぎ', type:'武器', atk:80, elmAtk:{'火':100}, val:1000000},
        {id:6, name:'天空のつるぎ', type:'武器', atk:300, elmAtk:{'雷':250, '光':250}, bonus:{finDmg:0.1}, val:99999999},
        {id:7, name:'かわの盾', type:'盾', def:20, val:1000},
        {id:8, name:'てつの盾', type:'盾', def:50, val:10000},
        {id:9, name:'ロトの盾', type:'盾', def:50, spd:110, val:1000000},
        {id:11, name:'天空の盾', type:'盾', def:210, bonus:{magDmg:1}, val:50000000},
        {id:13, name:'かわのぼうし', type:'頭', def:10, val:500},
        {id:14, name:'てつかぶと', type:'頭', def:25, val:5000},
        {id:19, name:'ぬののふく', type:'体', def:15, val:500},
        {id:20, name:'はがねのよろい', type:'体', def:40, val:5000},
        {id:25, name:'かわのくつ', type:'足', spd:5, val:200},
        {id:26, name:'てつのあしく', type:'足', spd:15, val:2000}
    ],
    OPTION_RULES: [
        {key:'hp', name:'HP増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'mp', name:'MP増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'atk', name:'攻撃力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'def', name:'防御力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'spd', name:'素早さ増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'mag', name:'魔法攻撃力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'elmAtk', name:'属性攻撃増', unit:'val', allowed:['UR','EX']},
        {key:'elmRes', name:'属性耐性増', unit:'val', allowed:['UR','EX']},
        {key:'magDmg', name:'魔法ダメージ増', unit:'%', allowed:['UR','EX']},
        {key:'sklDmg', name:'特技ダメージ増', unit:'%', allowed:['UR','EX']},
        {key:'finDmg', name:'最終与ダメージ増', unit:'%', allowed:['EX']},
        {key:'finRed', name:'最終被ダメージ減', unit:'%', allowed:['EX']},
        {key:'mpRed', name:'MP消費減', unit:'%', allowed:['EX']}
    ]
};

const rand = (n) => Math.floor(Math.random() * n);

/* ==========================================================================
   GAME CLASSES
   ========================================================================== */
class Entity {
    constructor(name, hp, mp, atk, def, spd, mag) {
        this.name = name;
        this.maxHp = hp; this.hp = hp;
        this.maxMp = mp; this.mp = mp;
        this.baseStats = { atk, def, spd, mag };
        this.buffs = { atk:1, def:1, spd:1, mag:1 }; 
        this.isDead = false;
        this.elmAtk = {}; this.elmRes = {};
        CONST.ELEMENTS.forEach(e => { this.elmAtk[e]=0; this.elmRes[e]=0; });
        this.bonuses = { magDmg:0, sklDmg:0, finDmg:0, finRed:0, mpRed:0 };
    }
    getStat(key) {
        let val = this.baseStats[key] || 0;
        if(this.buffs[key]) val *= this.buffs[key];
        return Math.floor(val);
    }
}

class Player extends Entity {
    constructor(template, img=null) {
        super(template.name, template.hp, template.mp, template.atk, template.def, template.spd, template.mag);
        this.id = Date.now() + Math.random();
        this.job = template.job; 
        this.rarity = template.rarity; 
        this.type = template.type;
        this.img = img;
        this.level = 1; this.exp = 0;
        this.count = 1; this.limitBreak = 0;
        this.equips = { 武器:null, 盾:null, 頭:null, 体:null, 足:null };
        this.skills = [];
        this.learnSkills();
    }

    getStat(key) {
        let val = this.baseStats[key] || 0;
        val = val * (1 + this.limitBreak * 0.1);
        let flat = 0;
        for(let p of CONST.PARTS) {
            const eq = this.equips[p];
            if(eq) {
                if(eq.data[key]) flat += eq.data[key];
                eq.opts.forEach(o => {
                    if(o.key === key && o.unit === 'val') flat += o.val;
                });
            }
        }
        val += flat;
        if(this.buffs[key]) val *= this.buffs[key];
        return Math.floor(val);
    }

    refreshBonuses() {
        this.bonuses = { magDmg:0, sklDmg:0, finDmg:0, finRed:0, mpRed:0 };
        CONST.ELEMENTS.forEach(e => { this.elmAtk[e]=0; this.elmRes[e]=0; });
        for(let p of CONST.PARTS) {
            const eq = this.equips[p];
            if(eq) {
                if(eq.data.elmAtk) Object.keys(eq.data.elmAtk).forEach(k => this.elmAtk[k] += eq.data.elmAtk[k]);
                if(eq.data.bonus) Object.keys(eq.data.bonus).forEach(k => this.bonuses[k] += eq.data.bonus[k]);
                eq.opts.forEach(o => {
                    if(o.key === 'elmAtk') this.elmAtk[o.elm] += o.val;
                    if(o.key === 'elmRes') this.elmRes[o.elm] += o.val;
                    if(this.bonuses[o.key] !== undefined && o.unit === '%') this.bonuses[o.key] += o.val;
                });
            }
        }
    }

    learnSkills() {
        const map = CONST.TYPE_SKILLS[this.type];
        if(!map) return;
        for(let lv=1; lv<=this.level; lv++) {
            if(map[lv]) {
                map[lv].forEach(sName => {
                    const sk = DB.SKILLS.find(s=>s.name===sName);
                    if(sk && !this.skills.some(s=>s.id===sk.id)) this.skills.push(sk);
                });
            }
        }
    }
    
    addExp(val) {
        this.exp += val;
        const next = this.level * 100;
        if(this.exp >= next) {
            this.level++;
            this.exp -= next;
            this.maxHp += Math.floor(this.maxHp * 0.1); 
            this.maxMp += Math.floor(this.maxMp * 0.1);
            Object.keys(this.baseStats).forEach(k => this.baseStats[k] += Math.ceil(this.baseStats[k]*0.05));
            this.learnSkills();
            return true;
        }
        return false;
    }
}

class Equipment {
    constructor(forceRarity=null) {
        this.id = Date.now() + Math.random();
        this.part = CONST.PARTS[rand(CONST.PARTS.length)];
        const cands = DB.EQUIPS.filter(e => e.type === this.part);
        this.data = cands[rand(cands.length)] || cands[0];
        this.type = this.data.type;
        
        let optNum = 0;
        const r = Math.random();
        if(r < 0.5) optNum=0; else if(r < 0.8) optNum=1; else if(r < 0.95) optNum=2; else optNum=3;
        
        this.opts = [];
        for(let i=0; i<optNum; i++) this.addOption(forceRarity);
        this.name = `${this.data.name}${optNum > 0 ? ' +'+optNum : ''}`;
    }
    addOption(forceRarity) {
        let rarity;
        if(forceRarity) rarity = forceRarity;
        else {
            const r = Math.random()*100;
            rarity = r<50?'N':(r<80?'R':(r<94?'SR':(r<99?'UR':'EX')));
        }
        const available = DB.OPTION_RULES.filter(rule => rule.allowed.includes(rarity));
        if(available.length === 0) return;
        
        const rule = available[rand(available.length)];
        const opt = { key: rule.key, name: rule.name, unit: rule.unit, rarity: rarity };
        
        if(rule.key.includes('elm')) {
            opt.elm = CONST.ELEMENTS[rand(CONST.ELEMENTS.length)];
            opt.val = (CONST.ELEMENTS.indexOf(rarity)+1) * 10 + rand(10); 
            opt.label = `${opt.elm}${rule.name}`;
        } else {
            if(rule.unit === 'val') {
                let base = 5; if(rule.key === 'hp' || rule.key === 'mp') base = 50;
                const mult = ['N','R','SR','UR','EX'].indexOf(rarity) + 1;
                opt.val = base * mult + rand(base);
            } else {
                const mult = ['N','R','SR','UR','EX'].indexOf(rarity) + 1;
                opt.val = 0.05 * mult; 
            }
            opt.label = rule.name;
        }
        this.opts.push(opt);
    }
}

class Monster extends Entity {
    constructor(data) {
        super(data.name, data.hp, data.mp, data.atk, data.def, data.spd, data.mag);
        this.data = data;
    }
}

/* ==========================================================================
   GAME STATE
   ========================================================================== */
const Game = {
    allCharacters: [],
    party: [null, null, null, null],
    items: {}, 
    inventory: [],
    book: { monsters:[] },
    gold: 1000, gems: 3000,
    
    start: () => {
        const name = document.getElementById('input-name').value;
        const file = document.getElementById('input-file').files[0];
        
        const init = (img) => {
            const p1 = new Player({...DB.CHARACTERS[0], name: name}, img);
            const p2 = new Player(DB.CHARACTERS[1]);
            const p3 = new Player(DB.CHARACTERS[3]);
            const p4 = new Player(DB.CHARACTERS[4]);
            
            Game.allCharacters.push(p1, p2, p3, p4);
            Game.party = [p1, p2, p3, p4];

            Game.addItem(1, 5); 
            Game.addItem(5, 2); 
            Game.addEquip(new Equipment());
            Game.addEquip(new Equipment());

            document.getElementById('start-screen').style.display = 'none';
            Dungeon.initField();
            UI.render();
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => init(e.target.result);
            reader.readAsDataURL(file);
        } else { init(null); }
    },

    addItem: (id, count=1) => {
        if(!Game.items[id]) Game.items[id] = 0;
        Game.items[id] += count;
    },
    useItem: (id) => {
        if(Game.items[id] > 0) {
            Game.items[id]--;
            return true;
        }
        return false;
    },
    addEquip: (eq) => { Game.inventory.push(eq); }
};

const Dungeon = {
    w: 30, h: 30, map: [], px: 15, py: 15,
    inDungeon: false, floor: 0,
    
    initField: () => {
        Dungeon.inDungeon = false; Dungeon.floor = 0;
        document.getElementById('loc-name').innerText = "フィールド";
        Dungeon.map = []; 
        for(let y=0; y<Dungeon.h; y++) {
            Dungeon.map[y] = [];
            for(let x=0; x<Dungeon.w; x++) {
                Dungeon.map[y][x] = Math.random()<0.1 ? 2 : (Math.random()<0.2 ? 1 : 0);
                if(x===0||x===Dungeon.w-1||y===0||y===Dungeon.h-1) Dungeon.map[y][x] = 2;
            }
        }
        Dungeon.px=15; Dungeon.py=15;
    },
    enter: () => { UI.closeMenu(); Dungeon.inDungeon = true; Dungeon.floor = 0; Dungeon.nextFloor(); },
    nextFloor: () => {
        Dungeon.floor++;
        document.getElementById('loc-name').innerText = `ダンジョン B${Dungeon.floor}`;
        UI.msg(`地下${Dungeon.floor}階へ降りた`);
        Dungeon.generateWormhole();
        UI.render();
    },
    generateWormhole: () => {
        Dungeon.map = [];
        for(let y=0; y<Dungeon.h; y++) Dungeon.map[y] = new Array(Dungeon.w).fill(1); 
        let cx = 15, cy = 15;
        Dungeon.map[cy][cx] = 0; Dungeon.px = cx; Dungeon.py = cy;
        const digCount = 400 + rand(200);
        for(let i=0; i<digCount; i++) {
            const dir = rand(4);
            let dx=0, dy=0;
            if(dir===0) dy=-1; if(dir===1) dx=1; if(dir===2) dy=1; if(dir===3) dx=-1;
            if(cy+dy*2>0 && cy+dy*2<Dungeon.h-1 && cx+dx*2>0 && cx+dx*2<Dungeon.w-1) {
                 Dungeon.map[cy+dy][cx+dx] = 0; cy += dy; cx += dx; Dungeon.map[cy][cx] = 0;
            }
        }
        let sx=0, sy=0;
        while(Dungeon.map[sy][sx]!==0 || (sx===Dungeon.px && sy===Dungeon.py)) { sx=rand(Dungeon.w); sy=rand(Dungeon.h); }
        Dungeon.map[sy][sx] = 2; 
        if(rand(100) < 40) { 
            let tx=0, ty=0;
            while(Dungeon.map[ty][tx]!==0) { tx=rand(Dungeon.w); ty=rand(Dungeon.h); }
            Dungeon.map[ty][tx] = 3; 
        }
    },
    move: (dx, dy) => {
        if(Battle.active) return;
        const nx = Dungeon.px + dx; const ny = Dungeon.py + dy;
        if(nx<0 || nx>=Dungeon.w || ny<0 || ny>=Dungeon.h) return;
        const tile = Dungeon.map[ny] ? Dungeon.map[ny][nx] : 1;
        if(tile === 1 || tile === 2 && !Dungeon.inDungeon) { UI.msg("進めない"); return; }
        Dungeon.px = nx; Dungeon.py = ny;
        UI.render();
        if(Dungeon.inDungeon && tile === 2) { if(confirm("降りますか？")) Dungeon.nextFloor(); return; }
        if(Dungeon.inDungeon && tile === 3) { Dungeon.openChest(nx, ny); return; }
        const rate = Dungeon.inDungeon ? 0.08 : 0.05;
        if(Math.random() < rate) Battle.start();
    },
    openChest: (x, y) => {
        Dungeon.map[y][x] = 0;
        UI.render();
        if(rand(100) < 50) {
            const itm = DB.ITEMS[rand(DB.ITEMS.length)];
            Game.addItem(itm.id, 1);
            alert(`${itm.name}を手に入れた！`);
        } else {
            const eq = new Equipment();
            Game.addEquip(eq);
            alert(`${eq.name}を手に入れた！`);
        }
    }
};

/* ==========================================================================
   BATTLE SYSTEM
   ========================================================================== */
const Battle = {
    active: false,
    auto: false,
    enemies: [],
    currActorIdx: 0,
    playerActions: [],

    toggleAuto: () => {
        Battle.auto = !Battle.auto;
        const btn = document.getElementById('auto-btn');
        btn.innerText = `AUTO:${Battle.auto?'ON':'OFF'}`;
        btn.className = `btn ${Battle.auto?'on':''}`;
        if(Battle.auto && document.getElementById('battle-cmd-root').style.display !== 'none') {
            Battle.onFight();
        }
    },

    start: () => {
        Battle.active = true;
        document.getElementById('battle-ui').style.display = 'flex';
        document.getElementById('field-ui').style.display = 'none';
        Battle.enemies = [];
        
        Game.party.forEach(p => { if(p) p.refreshBonuses(); });

        const floorFactor = Math.floor(Dungeon.floor / 5);
        const num = 1 + rand(Dungeon.inDungeon ? 3 : 2);
        
        if(Dungeon.inDungeon && Dungeon.floor % 10 === 0 && Dungeon.floor > 0) {
            const boss = new Monster(DB.MONSTERS.find(m=>m.name.includes('ドラゴン')||m.name.includes('魔王'))); // Fallback
            if(boss) boss.hp *= (1 + Dungeon.floor * 0.1);
            Battle.enemies.push(boss || new Monster(DB.MONSTERS[0]));
        } else {
            let list = DB.MONSTERS.filter(m => !m.name.includes('ドラゴン') && !m.name.includes('魔王') && m.id !== 26);
            if(Dungeon.inDungeon && rand(100) < 2) list = [DB.MONSTERS.find(m=>m.id===26)];

            for(let i=0; i<num; i++) {
                const base = list[Math.min(list.length-1, rand(list.length) + Math.min(2, floorFactor))];
                const m = new Monster(base);
                m.hp = Math.floor(m.hp * (1 + Dungeon.floor * 0.05));
                m.atk = Math.floor(m.atk * (1 + Dungeon.floor * 0.05));
                m.name += String.fromCharCode(65+i);
                Battle.enemies.push(m);
            }
        }
        Battle.log("モンスターが現れた！");
        Battle.refreshView();
        Battle.onRootPhase();
    },

    onRootPhase: () => {
        if(Battle.auto) { Battle.onFight(); return; }
        document.getElementById('battle-cmd-root').style.display = 'grid';
        document.getElementById('battle-cmd-sub').style.display = 'none';
        Battle.log("コマンド？");
    },
    
    onFight: () => {
        document.getElementById('battle-cmd-root').style.display = 'none';
        document.getElementById('battle-cmd-sub').style.display = Battle.auto ? 'none' : 'grid';
        Battle.currActorIdx = 0;
        Battle.playerActions = [];
        Battle.nextInput();
    },
    
    nextInput: () => {
        while(Battle.currActorIdx < Game.party.length) {
            const p = Game.party[Battle.currActorIdx];
            if(p && p.hp > 0) {
                if(Battle.auto) {
                    const t = Battle.enemies.filter(e=>e.hp>0);
                    if(t.length>0) Battle.playerActions.push({actor:p, skill:DB.SKILLS[0], targets:[t[rand(t.length)]]});
                    Battle.currActorIdx++;
                } else {
                    Battle.log(`${p.name} の行動`);
                    return; 
                }
            } else {
                Battle.currActorIdx++;
            }
        }
        Battle.executeTurn();
    },
    
    backToRoot: () => {
        if(Battle.currActorIdx === 0) Battle.onRootPhase();
        else {
            Battle.currActorIdx--;
            while(Battle.currActorIdx > 0 && (!Game.party[Battle.currActorIdx] || Game.party[Battle.currActorIdx].hp <= 0)) {
                Battle.currActorIdx--;
            }
            Battle.playerActions.pop();
            Battle.nextInput();
        }
    },

    selectAction: (type) => {
        const actor = Game.party[Battle.currActorIdx];
        if(type==='attack') Battle.selectTarget(DB.SKILLS[0], t=>Battle.commit(actor, DB.SKILLS[0], t));
        if(type==='guard') Battle.commit(actor, {name:'防御',type:'防御',speed:9999}, actor);
    },

    openSkillList: (cat) => {
        const actor = Game.party[Battle.currActorIdx];
        const list = actor.skills.filter(s => cat==='magic' ? ['魔法','回復','蘇生'].includes(s.type) : ['物理','強化','特殊'].includes(s.type));
        UI.showList(list, sk => {
            let cost = sk.mp;
            if(actor.bonuses && actor.bonuses.mpRed) cost = Math.floor(cost * (1 - actor.bonuses.mpRed));
            if(actor.mp < cost) { UI.msg("MP不足"); return false; }
            setTimeout(() => {
                Battle.selectTarget(sk, t => Battle.commit(actor, sk, t));
            }, 50);
            return true;
        }, true);
    },

    openItemList: () => {
        const actor = Game.party[Battle.currActorIdx];
        const list = Object.keys(Game.items).map(id => {
            const meta = DB.ITEMS.find(i=>i.id==parseInt(id));
            return { ...meta, count: Game.items[id], isItem: true };
        }).filter(i => i.count > 0);
        
        if(list.length===0) { UI.msg("道具がない"); return; }
        
        UI.showList(list, itm => {
            setTimeout(() => {
                Battle.selectTarget(itm, t => {
                    const sk = { name:itm.name, type:itm.type, val:itm.val, speed:9999, isItem:true, id:itm.id, target:itm.target };
                    Battle.commit(actor, sk, t);
                });
            }, 50);
            return true;
        }, true);
    },

    selectTarget: (sk, cb) => {
        let list = [];
        if(['HP回復','MP回復','回復','強化','蘇生'].includes(sk.type)) {
             list = Game.party.filter(p => p !== null); 
             if(sk.type==='蘇生') list = list.filter(p => p.hp <= 0);
        } else {
            list = Battle.enemies.filter(e => e.hp > 0);
        }
        
        if(list.length === 0) { UI.msg("対象がいません"); return; }

        if(sk.target==='全体'||sk.target==='ランダム'||(sk.isItem && sk.target==='全体')) {
            cb(list);
        } else if(sk.target==='自分') {
            cb([Game.party[Battle.currActorIdx]]);
        } else {
            UI.showList(list, t => { cb([t]); return true; }, false, true); // Show detail status
        }
    },

    commit: (actor, skill, targets) => {
        Battle.playerActions.push({ actor, skill, targets });
        Battle.currActorIdx++;
        Battle.nextInput();
    },

    onRun: () => {
        if(rand(100) < 50) { Battle.log("逃げ出した！"); setTimeout(Battle.end, 1000); }
        else { Battle.log("回り込まれた！"); Battle.playerActions = []; Battle.executeTurn(); }
    },

    executeTurn: async () => {
        document.getElementById('battle-cmd-sub').style.display = 'none';
        
        let queue = [...Battle.playerActions];
        Battle.enemies.forEach(e => {
            if(e.hp>0) {
                const actId = e.data.acts[rand(e.data.acts.length)];
                let sk = DB.SKILLS.find(s=>s.id===actId) || DB.SKILLS[0];
                const validTargets = Game.party.filter(p=>p&&p.hp>0);
                if(validTargets.length>0) {
                    let targets = [validTargets[rand(validTargets.length)]];
                    if(sk.target==='全体') targets = validTargets;
                    queue.push({ actor:e, skill:sk, targets });
                }
            }
        });

        queue.forEach(q => q.speed = q.skill.speed || (q.actor.getStat('spd') * (0.8+Math.random()*0.4)));
        queue.sort((a,b) => b.speed - a.speed);

        for(let act of queue) {
            if(!Battle.active) break;
            const user = act.actor;
            if(user.hp <= 0) continue;

            const sk = act.skill;
            
            if(sk.mp > 0) {
                let cost = sk.mp;
                if(user.bonuses && user.bonuses.mpRed) cost = Math.floor(cost * (1 - user.bonuses.mpRed));
                user.mp -= cost;
            }
            if(sk.isItem) {
                if(Game.items[sk.id] > 0) Game.items[sk.id]--;
                else continue;
            }

            let targets = Array.isArray(act.targets) ? act.targets : [act.targets];
            targets = targets.filter(t => sk.type==='蘇生' ? t.hp<=0 : t.hp>0);
            if(targets.length === 0) continue;

            Battle.log(`${user.name}の${sk.name}！`);
            await UI.wait(400);

            if(sk.type==='防御') {
                Battle.log("身を守っている");
                continue;
            }

            for(let t of targets) {
                let dmg = 0;
                let isHeal = ['回復','蘇生','HP回復','MP回復'].includes(sk.type);
                
                if(isHeal) {
                    if(sk.type==='蘇生') {
                        if(Math.random()<sk.rate) { t.hp = Math.floor(t.maxHp*0.5); t.isDead = false; Battle.log(`${t.name}は生き返った`); }
                        else Battle.log("ミス！");
                    } else if(sk.type==='MP回復') {
                        let rec = Math.floor((sk.val || 0) * (0.9+Math.random()*0.2));
                        t.mp = Math.min(t.maxMp, t.mp + rec);
                        Battle.log(`${t.name}のMPが ${rec} 回復`);
                        UI.showDamage(t, rec, '#88f');
                    } else {
                        let base = sk.val ? sk.val : (user.getStat('mag')+sk.base)*sk.rate;
                        let rec = Math.floor(base * (0.9+Math.random()*0.2));
                        t.hp = Math.min(t.maxHp, t.hp + rec);
                        Battle.log(`${t.name}のHPが ${rec} 回復`);
                        UI.showDamage(t, rec, '#4f4');
                    }
                } else if(sk.type==='強化') {
                    if(sk.buff) Object.keys(sk.buff).forEach(k => t.buffs[k] = sk.buff[k]);
                    Battle.log(`${t.name}の能力が上がった`);
                } else {
                    let atk = user.getStat(sk.type==='物理'?'atk':'mag');
                    let def = t.getStat('def');
                    
                    let base = ((atk+sk.base)*sk.rate) - (sk.type==='物理'?def/2:0);
                    if(sk.elm) base += (user.elmAtk[sk.elm]||0) - (t.elmRes[sk.elm]||0);
                    
                    let mul = 1.0;
                    if(user.bonuses) {
                        if(sk.type==='魔法') mul += user.bonuses.magDmg;
                        if(sk.type==='物理' && sk.name!=='こうげき') mul += user.bonuses.sklDmg;
                        mul += user.bonuses.finDmg;
                    }
                    base *= mul;
                    
                    if(t.bonuses && t.bonuses.finRed) base *= (1 - t.bonuses.finRed);

                    let dmg = Math.max(1, Math.floor(base * (0.8+Math.random()*0.4)));
                    
                    for(let i=0; i<sk.count; i++) {
                        t.hp -= dmg;
                        UI.showDamage(t, dmg);
                        Battle.log(`${t.name}に ${dmg} のダメージ`);
                        if(t.hp<=0) { t.hp=0; t.isDead=true; Battle.log(`${t.name}は倒れた`); break; }
                        await UI.wait(150);
                    }
                }
            }
            Battle.refreshView();
            
            if(Battle.enemies.every(e=>e.hp<=0)) { await Battle.win(); return; }
            const liveParty = Game.party.filter(p=>p&&p.hp>0);
            if(liveParty.length===0) { Battle.lose(); return; }
            await UI.wait(300);
        }
        Battle.onRootPhase();
    },

    win: async () => {
        Battle.log("勝利！");
        await UI.wait(1000);
        let exp=0, gold=0, gem=0;
        
        Battle.enemies.forEach(e => {
            exp += e.data.exp; gold += e.data.gold; gem += (e.data.gem || 0);
            if(!Game.book.monsters.includes(e.data.id)) Game.book.monsters.push(e.data.id);
            if(rand(100) < e.data.dropRate) {
                const item = new Equipment();
                Game.addEquip(item);
                Battle.log(`${item.name}を入手`);
            }
        });
        
        Game.gold += gold; Game.gems += gem;
        Battle.log(`${exp}EXP ${gold}G ${gem}GEM 入手`);
        Game.party.forEach(p => { if(p && p.hp>0 && p.addExp(exp)) Battle.log(`${p.name} LvUP!`); });
        
        await UI.wait(1000);
        Battle.end();
    },

    lose: () => {
        Battle.log("全滅...");
        setTimeout(() => location.reload(), 2000);
    },

    end: () => {
        Battle.active = false;
        document.getElementById('battle-ui').style.display = 'none';
        document.getElementById('field-ui').style.display = 'flex';
        Game.party.forEach(p => { if(p) p.buffs = {atk:1, def:1, spd:1, mag:1}; });
        UI.render();
    },

    log: (msg) => {
        const d = document.getElementById('battle-log');
        d.innerHTML += `<div>${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    },

    refreshView: () => {
        const sc = document.getElementById('battle-scene');
        sc.innerHTML = '';
        Battle.enemies.forEach(e => {
            const d = document.createElement('div');
            d.className = `enemy-sprite ${e.hp<=0?'dead':''}`;
            d.style.background = e.data.id >= 10 ? '#800' : '#444'; 
            d.innerHTML = `<span style="font-size:10px; text-shadow:1px 1px 0 #000;">${e.name}</span>
            <div class="enemy-hp-bar"><div class="enemy-hp-val" style="width:${(e.hp/e.maxHp)*100}%"></div></div>`;
            sc.appendChild(d);
        });
        for(let i=0; i<4; i++) {
            const p = Game.party[i];
            const div = document.getElementById(`p-stat-${i+1}`);
            if(p) {
                div.innerHTML = `<div>${p.name}</div><div>HP ${p.hp}/${p.maxHp}</div><div>MP ${p.mp}/${p.maxMp}</div><div>Lv.${p.level}</div>`;
                div.className = "p-stat-box " + (p.hp<=0 ? "p-dead" : (p.hp <= p.maxHp/2 ? "p-warn" : ""));
            } else {
                div.innerHTML = '-';
                div.className = "p-stat-box";
            }
        }
    }
};

/* ==========================================================================
   UI CONTROLLERS
   ========================================================================== */
const UI = {
    canvas: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    
    msg: (t) => document.getElementById('msg-box').innerText = t,
    
    render: () => {
        const ctx = UI.ctx;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,320,320);
        
        if (!Dungeon.map || Dungeon.map.length === 0) return;

        const ts = 32;
        const cx = Dungeon.px-5; const cy = Dungeon.py-5;
        for(let y=0; y<11; y++) {
            for(let x=0; x<11; x++) {
                const mx=cx+x, my=cy+y;
                if(mx>=0 && mx<Dungeon.w && my>=0 && my<Dungeon.h) {
                    if (Dungeon.map[my]) {
                        const t = Dungeon.map[my][mx];
                        if(t===0) ctx.fillStyle = '#444'; 
                        else if(t===1) ctx.fillStyle = '#000'; 
                        else if(t===2) ctx.fillStyle = '#aaa'; 
                        else if(t===3) ctx.fillStyle = '#dd0'; 
                        if(!Dungeon.inDungeon) { if(t===0) ctx.fillStyle='#282'; if(t===2) ctx.fillStyle='#228'; }
                        ctx.fillRect(x*ts, y*ts, ts, ts);
                        ctx.strokeStyle='#222'; ctx.strokeRect(x*ts, y*ts, ts, ts);
                        if(t===2 && Dungeon.inDungeon) { ctx.fillStyle='#fff'; ctx.fillText('▼', x*ts+10, y*ts+20); }
                        if(t===3 && Dungeon.inDungeon) { ctx.fillStyle='#000'; ctx.fillText('箱', x*ts+10, y*ts+20); }
                    }
                }
            }
        }
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(5*ts+16, 5*ts+16, 10, 0, Math.PI*2); ctx.fill();
    },

    openMenu: () => {
        if(Battle.active) return;
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('menu-gold').innerText = Game.gold;
        document.getElementById('menu-gem').innerText = Game.gems;
        UI.renderMenuPartyStatus();
    },
    closeMenu: () => { document.getElementById('menu-screen').style.display = 'none'; },

    renderMenuPartyStatus: () => {
        const c = document.getElementById('menu-party-status');
        c.innerHTML = '';
        Game.party.forEach(p => {
            const div = document.createElement('div');
            if(p) {
                div.innerHTML = `
                    <div style="font-weight:bold; color:#fff;">${p.name}</div>
                    <div style="font-size:8px; color:#aaa;">Lv.${p.level}</div>
                    <div class="enemy-hp-bar"><div class="enemy-hp-val" style="width:${(p.hp/p.maxHp)*100}%"></div></div>
                    <div style="font-size:8px;">${p.hp}/${p.maxHp}</div>
                    <div class="mp-bar"><div class="mp-val" style="width:${(p.mp/p.maxMp)*100}%"></div></div>
                    <div style="font-size:8px;">${p.mp}/${p.maxMp}</div>
                `;
            } else {
                div.innerHTML = `<div style="padding-top:20px; color:#555;">-</div>`;
            }
            c.appendChild(div);
        });
    },

    showStatusList: () => {
        // Only current party
        UI.showList(Game.party.filter(p=>p!==null), (char) => {
            UI.showStatusDetail(char);
            return true; 
        }, false, true); // Show HP/MP in list
    },

    showStatusDetail: (p) => {
        p.refreshBonuses();
        const makeTab = (id, label, active) => `<div class="tab-btn ${active?'active':''}" onclick="UI.switchStatusTab('${id}')">${label}</div>`;
        const makeContent = (id, content, active) => `<div id="tab-${id}" class="tab-content ${active?'active':''}" style="height:250px; overflow-y:auto;">${content}</div>`;

        let eqList = CONST.PARTS.map(part => `<div>${part}: ${p.equips[part] ? p.equips[part].name : '-'}</div>`).join('');
        let t1 = `<div style="display:flex; gap:10px;">${p.img ? `<img src="${p.img}" class="profile-img">` : `<div class="profile-img no-img">NO IMG</div>`}
            <div><div style="font-size:16px; font-weight:bold;">${p.name}</div><div>${p.job} (★${p.rarity})</div></div></div>
            <div style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">${eqList}</div>`;

        let nextExp = (p.level * 100) - p.exp;
        let t2 = `<table class="stat-table">
            <tr><td>Lv</td><td>${p.level}</td></tr>
            <tr><td>Next</td><td>${nextExp}</td></tr>
            <tr><td>HP</td><td>${p.hp} / ${p.maxHp}</td></tr><tr><td>MP</td><td>${p.mp} / ${p.maxMp}</td></tr><tr><td>攻撃力</td><td>${p.getStat('atk')}</td></tr><tr><td>防御力</td><td>${p.getStat('def')}</td></tr><tr><td>素早さ</td><td>${p.getStat('spd')}</td></tr><tr><td>魔攻</td><td>${p.getStat('mag')}</td></tr></table>`;

        let elms = CONST.ELEMENTS.map(e => `<tr><td>${e}</td><td>攻:${p.elmAtk[e]} / 耐:${p.elmRes[e]}</td></tr>`).join('');
        let t3 = `<table class="stat-table">${elms}<tr><td>魔ダメ増</td><td>${Math.floor(p.bonuses.magDmg*100)}%</td></tr><tr><td>特技ダメ増</td><td>${Math.floor(p.bonuses.sklDmg*100)}%</td></tr></table>`;

        const setDesc = (desc) => document.getElementById('sub-footer').innerText = desc;
        window.setDesc = setDesc;

        const magics = p.skills.filter(s => ['魔法','回復','蘇生'].includes(s.type));
        let t4 = magics.map(s => `<div class="item-row" onclick="setDesc('${s.desc}')">${s.name} <span style="color:#88f">MP:${s.mp}</span></div>`).join('');

        const skills = p.skills.filter(s => !['魔法','回復','蘇生'].includes(s.type));
        let t5 = skills.map(s => `<div class="item-row" onclick="setDesc('${s.desc}')">${s.name} <span style="color:#88f">MP:${s.mp}</span></div>`).join('');

        let html = `<div class="tab-header">${makeTab(1,'基本',true)} ${makeTab(2,'能力',false)} ${makeTab(3,'特殊',false)} ${makeTab(4,'魔法',false)} ${makeTab(5,'特技',false)}</div>
            ${makeContent(1,t1,true)} ${makeContent(2,t2,false)} ${makeContent(3,t3,false)} ${makeContent(4,t4,false)} ${makeContent(5,t5,false)}`;
        
        UI.openSubScreen("ステータス詳細", html);
        document.getElementById('sub-footer').innerText = "タップで説明を表示";
    },

    switchStatusTab: (id) => {
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        const btns = document.querySelectorAll('.tab-btn');
        btns[id-1].classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
    },

    showItems: () => {
        const list = Object.keys(Game.items).map(id => {
            const m = DB.ITEMS.find(i=>i.id==parseInt(id));
            return { ...m, count: Game.items[id] };
        }).filter(i=>i.count>0);
        UI.openSubScreen("道具一覧", list.map(i => `<div class="item-row" onclick="UI.useItemField(${i.id})">${i.name} x${i.count}</div>`).join('') || '<div>道具を持っていません</div>');
        document.getElementById('sub-footer').innerText = "タップで説明・使用";
    },

    useItemField: (id) => {
        const meta = DB.ITEMS.find(i=>i.id===id);
        document.getElementById('sub-footer').innerText = meta.desc;
        
        // Click to use logic needs 2 steps? Or simple confirm?
        // Current logic is simple confirm via target selection
        if(!['HP回復','MP回復'].includes(meta.type)) { alert("ここでは使えません"); return; }
        
        setTimeout(() => {
            if(confirm(`${meta.name}を使いますか？`)) {
                let validTargets = Game.party.filter(p=>p!==null);
                UI.showList(validTargets, target => {
                    if(Game.useItem(id)) {
                        if(meta.type==='HP回復') target.hp = Math.min(target.maxHp, target.hp + meta.val);
                        if(meta.type==='MP回復') target.mp = Math.min(target.maxMp, target.mp + meta.val);
                        alert(`${target.name}は回復した！`);
                        UI.showItems(); UI.renderMenuPartyStatus(); return true;
                    }
                    return false;
                }, false, true);
            }
        }, 50);
    },

    showEquip: () => {
        const targets = Game.party.filter(p=>p!==null);
        UI.showList(targets, p => {
            UI.showEquipParts(p);
            return true; // Close char list
        }, false, true); // Show status in char list
    },

    showEquipParts: (p) => {
        const header = `<div style="font-size:11px; margin-bottom:5px;">
            ${p.name} <span class="rarity-${p.rarity}">[${p.rarity}]</span> Lv.${p.level} (${p.job})<br>
            HP:${p.hp}/${p.maxHp} MP:${p.mp}/${p.maxMp} 攻:${p.getStat('atk')} 防:${p.getStat('def')} 魔:${p.getStat('mag')} 速:${p.getStat('spd')}
        </div>`;
        
        const partsList = CONST.PARTS.map(part => {
            const eq = p.equips[part];
            return { id:part, name:`${part}: ${eq ? eq.name : '(なし)'}` };
        });

        UI.openSubScreen("装備変更 (部位選択)", header + `<div class="scroll-area">` + partsList.map(pt => 
            `<div class="item-row" onclick="UI.showEquipCandidates('${pt.id}', ${p.id})">${pt.name}</div>`
        ).join('') + `</div>`);
        document.getElementById('sub-footer').innerText = "部位を選択してください";
    },

    showEquipCandidates: (part, pid) => {
        const p = Game.allCharacters.find(c => c.id === pid);
        const equips = Game.inventory.filter(e => e.type === part);
        
        const list = equips.map(e => {
            let owner = null;
            Game.allCharacters.forEach(c => { if(c.equips[part] === e) owner = c; });
            const desc = e.opts.map(o => o.unit==='val' ? `${o.label}+${o.val}` : `${o.label}+${Math.floor(o.val*100)}%`).join(' ');
            const prefix = owner ? (owner===p ? '[E]' : '[他]') : '';
            return {...e, name: prefix + e.name, desc: desc || '追加効果なし', isOwned: !!owner};
        });
        
        list.unshift({id:'remove', name:'(外す)', type:part});

        const m = document.getElementById('list-modal');
        const c = document.getElementById('list-container');
        const d = document.getElementById('list-desc');
        c.innerHTML = '';
        document.getElementById('list-title').innerText = `${part}の選択`;
        d.innerText = "タップで装備";
        
        list.forEach(eq => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `<div>${eq.name} <br><small style="color:#aaa">${eq.desc||''}</small></div>`;
            div.onclick = () => {
                if(eq.id === 'remove') {
                    p.equips[part] = null;
                } else {
                    Game.allCharacters.forEach(c => { if(c.equips[part]===eq) c.equips[part]=null; });
                    p.equips[part] = eq;
                }
                m.style.display = 'none';
                UI.showEquipParts(p); // Back to parts
            };
            c.appendChild(div);
        });
        const btn = m.querySelector('.btn');
        btn.onclick = () => {
            m.style.display = 'none';
            UI.showEquipParts(p);
        };
        m.style.display = 'flex';
    },

    showPartyForm: () => {
        const render = () => {
            let html = "";
            for(let i=0; i<4; i++) {
                const p = Game.party[i];
                html += `<div class="item-row" onclick="UI.swapMember(${i})">
                    [${i+1}] ${p ? `${p.name} <span class="rarity-${p.rarity}">[${p.rarity}]</span> (${p.job}) Lv.${p.level} <small>HP:${p.hp} MP:${p.mp}</small>` : '--- 空き ---'}
                </div>`;
            }
            UI.openSubScreen("パーティ編成 (タップで入替)", html);
            document.getElementById('sub-footer').innerText = "変更したい枠をタップ";
        };
        render();
    },

    swapMember: (slotIdx) => {
        UI.showList(Game.allCharacters, (char) => {
            const currentIdx = Game.party.indexOf(char);
            if(currentIdx >= 0) {
                const temp = Game.party[slotIdx];
                Game.party[slotIdx] = char;
                Game.party[currentIdx] = temp;
            } else {
                Game.party[slotIdx] = char;
            }
            UI.showPartyForm(); UI.renderMenuPartyStatus();
            return true;
        }, false, true);
    },
    
    showCharList: () => {
        const html = Game.allCharacters.map(c => `
            <div class="item-row">
                <div class="list-thumb">${c.img?'IMG':'No Img'}</div>
                <div style="flex:1;">
                    <div><span class="rarity-${c.rarity}">[${c.rarity}]</span> ${c.name} (${c.job}) Lv.${c.level}</div>
                    <div style="font-size:10px; color:#ccc;">HP:${c.hp}/${c.maxHp} MP:${c.mp}/${c.maxMp} 攻:${c.getStat('atk')}</div>
                </div>
                ${c.count > c.limitBreak + 1 ? `<button class="btn" onclick="UI.limitBreak(${c.id})">強化</button>` : ''}
            </div>
        `).join('');
        UI.openSubScreen("仲間一覧", html);
        document.getElementById('sub-footer').innerText = "重複キャラで強化が可能";
    },

    limitBreak: (id) => {
        const char = Game.allCharacters.find(c => c.id === id);
        if(char && char.count > char.limitBreak + 1) {
            char.limitBreak++;
            alert(`${char.name}を強化しました！(ステータス+10%)`);
            UI.showCharList();
        }
    },

    showMonsterBook: () => {
        const html = DB.MONSTERS.map(m => {
            const known = Game.book.monsters.includes(m.id);
            return `<div class="item-row" onclick="${known ? `UI.showMonsterDetail(${m.id})` : ''}" style="color:${known?'#fff':'#555'}">
                ${known ? `<div><strong>${m.name}</strong></div>` : `<div>？？？</div>`}
            </div>`;
        }).join('');
        UI.openSubScreen("魔物図鑑 (タップで詳細)", html);
        document.getElementById('sub-footer').innerText = "";
    },

    showMonsterDetail: (id) => {
        const m = DB.MONSTERS.find(e => e.id === id);
        if(!m) return;
        const skills = m.acts.map(sid => {
            const sk = DB.SKILLS.find(s=>s.id===sid);
            return sk ? sk.name : '通常攻撃';
        }).join(', ');
        const html = `
            <div class="mon-img-area">No Image</div>
            <div style="text-align:center; font-size:18px; margin-bottom:10px;">${m.name}</div>
            <table class="stat-table">
                <tr><td>HP</td><td>${m.hp}</td><td>MP</td><td>${m.mp}</td></tr>
                <tr><td>攻撃力</td><td>${m.atk}</td><td>防御力</td><td>${m.def}</td></tr>
                <tr><td>素早さ</td><td>${m.spd}</td><td>魔攻</td><td>${m.mag}</td></tr>
                <tr><td>EXP</td><td>${m.exp}</td><td>GOLD</td><td>${m.gold}</td></tr>
                <tr><td>出現</td><td>B${m.minF}～B${m.maxF}</td><td>Drop</td><td>${m.dropRate}%</td></tr>
            </table>
            <div style="margin-top:10px; font-size:12px; color:#aaa;"><strong>使用スキル:</strong><br>${skills}</div>`;
        UI.openSubScreen(m.name, html);
    },

    showGacha: () => {
        UI.openSubScreen("ガチャ", `
            <div style="text-align:center; padding:20px;">
                <p>GEM: ${Game.gems}</p>
                <button class="btn" style="margin:10px auto; width:200px;" onclick="UI.pullGacha(1)">1回召喚 (300 GEM)</button>
                <button class="btn" style="margin:10px auto; width:200px; background:#622;" onclick="UI.pullGacha(10)">10連召喚 (3000 GEM)</button>
                <div id="gacha-res" style="margin-top:20px; text-align:left;"></div>
            </div>
        `);
        document.getElementById('sub-footer').innerText = "強力な仲間を召喚！";
    },

    pullGacha: (times) => {
        const cost = times * 300;
        if(Game.gems < cost) { alert("GEM不足"); return; }
        Game.gems -= cost;
        document.getElementById('menu-gem').innerText = Game.gems;
        
        const overlay = document.getElementById('gacha-overlay');
        const resDiv = document.getElementById('gacha-res');
        resDiv.innerHTML = '';
        
        let results = [];
        let hasUR = false;
        
        for(let i=0; i<times; i++) {
            const r = Math.random()*100;
            let rarity = r<50?'N':(r<80?'R':(r<94?'SR':(r<99?'UR':'EX')));
            if(rarity === 'UR' || rarity === 'EX') hasUR = true;
            
            let pool = DB.CHARACTERS.filter(c => c.rarity === rarity);
            if(pool.length === 0) { pool = DB.CHARACTERS; rarity = pool[0].rarity; }
            const tmpl = pool[rand(pool.length)];
            
            let char = Game.allCharacters.find(c => c.name === tmpl.name && c.job === tmpl.job);
            let isNew = false;
            if(char) char.count++;
            else {
                char = new Player(tmpl);
                Game.allCharacters.push(char);
                isNew = true;
            }
            results.push({char, rarity, isNew});
        }

        overlay.style.display = 'flex';
        if(hasUR) overlay.classList.add('rainbow-bg');
        else overlay.classList.remove('rainbow-bg');
        
        setTimeout(() => {
            overlay.style.display = 'none';
            results.forEach(res => {
                resDiv.innerHTML += `
                    <div style="border-bottom:1px solid #333; padding:5px;">
                        <span class="rarity-${res.rarity}">[${res.rarity}]</span> ${res.char.name} 
                        <span style="font-size:10px; color:#aaa;">${res.isNew ? "NEW!" : "(+1)"}</span>
                    </div>
                `;
            });
        }, 2000);
    },

    openSubScreen: (title, html) => {
        document.getElementById('sub-title').innerText = title;
        document.getElementById('sub-content').innerHTML = html;
        document.getElementById('sub-screen').style.display = 'flex';
    },

    // Helper
    // showDetailStatus: Show HP/MP/Lv etc in list item
    showList: (items, onSelect, showDesc = false, showDetailStatus = false) => {
        const m = document.getElementById('list-modal');
        const c = document.getElementById('list-container');
        const d = document.getElementById('list-desc');
        c.innerHTML = '';
        d.innerText = showDesc ? 'タップで説明を表示' : '';

        // Reset cancel button behavior
        const btn = m.querySelector('.btn');
        btn.onclick = () => UI.closeList();

        let selectedId = null;

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-row';
            
            let info = '';
            if(item.mp && !showDetailStatus) info += ` <span style="color:#88f; font-size:11px;">MP:${item.mp}</span>`;
            if(item.count) info += ` x${item.count}`;
            
            let statusHtml = '';
            // Enhanced status display for Party Form / Equip / Char List
            if(showDetailStatus && item.maxHp) {
                statusHtml = `
                <div style="font-size:9px; color:#ccc; margin-left:5px;">
                    <span class="rarity-${item.rarity}">[${item.rarity}]</span> ${item.job} Lv.${item.level}<br>
                    HP ${item.hp}/${item.maxHp} MP ${item.mp}/${item.maxMp} 攻${item.getStat('atk')}
                </div>`;
            } else if (showDetailStatus && item.hp !== undefined) {
                 // Simple Item Target
                 statusHtml = `
                <div style="font-size:9px; margin-top:2px;">
                    HP ${item.hp}/${item.maxHp}
                </div>`;
            }

            div.innerHTML = `<div style="flex:1;">${item.name}${info}</div>${statusHtml}`;
            
            div.onclick = () => {
                if(showDesc && item.desc) {
                    if(selectedId === item.id) {
                        if(onSelect(item)) UI.closeList();
                    } else {
                        selectedId = item.id;
                        d.innerText = item.desc;
                        Array.from(c.children).forEach(ch => ch.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                } else {
                    if(onSelect(item)) UI.closeList();
                }
            };
            c.appendChild(div);
        });
        m.style.display = 'flex';
    },
    closeList: () => { document.getElementById('list-modal').style.display = 'none'; },

    showDamage: (t, d, color='#fff') => {
        const el = document.createElement('div');
        el.className = 'damage-pop'; el.innerText = d; el.style.color = color;
        if(t.isDead !== undefined) { 
             el.style.left = (20+rand(60))+'%'; el.style.top = (20+rand(20))+'%';
        }
        document.getElementById('battle-scene').appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },
    
    onOk: () => { if(!Battle.active) UI.openMenu(); },
    wait: (ms) => new Promise(r=>setTimeout(r,ms))
};

window.addEventListener('keydown', e => {
    if(e.key==='ArrowUp') Dungeon.move(0,-1);
    if(e.key==='ArrowDown') Dungeon.move(0,1);
    if(e.key==='ArrowLeft') Dungeon.move(-1,0);
    if(e.key==='ArrowRight') Dungeon.move(1,0);
    if(e.key==='Enter') UI.onOk();
});
['up','down','left','right'].forEach(d => 
    document.getElementById('btn-'+d).onclick = () => 
    Dungeon.move(d==='left'?-1:d==='right'?1:0, d==='up'?-1:d==='down'?1:0)
);

const resize = () => {
    const p = UI.canvas.parentElement;
    UI.canvas.width = p.clientWidth; UI.canvas.height = p.clientHeight;
    if(!Battle.active) UI.render();
};
window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>
