<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quest of Elements - Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        :root {
            --bg-color: #101010; --win-bg: rgba(0,0,0,0.92); --win-border: #fff;
            --text-color: #fff; --accent: #ffd700; --danger: #ff4444; --mp: #4488ff;
            --rare-n: #a0a0a0; --rare-r: #40e040; --rare-sr: #40e0e0; --rare-ur: #e040e0; --rare-ex: #ffff00;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            background: var(--bg-color); color: var(--text-color);
            font-family: 'DotGothic16', sans-serif;
            margin: 0; padding: 0; overflow: hidden;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            user-select: none; -webkit-user-select: none;
        }
        #game-container {
            position: relative; width: 100%; max-width: 600px; height: 100%; max-height: 900px;
            background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        #canvas-wrapper { flex: 1; position: relative; overflow: hidden; border-bottom: 2px solid #fff; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        .dialog-box {
            background: var(--win-bg); border: 2px solid var(--win-border); border-radius: 4px;
            padding: 8px; margin: 5px; pointer-events: auto; font-size: 14px; line-height: 1.4;
        }
        .full-screen-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; pointer-events: auto; overflow-y: auto;
        }
        
        .btn {
            background: #333; border: 2px solid #666; color: #fff; padding: 10px;
            font-family: inherit; font-size: 14px; cursor: pointer; text-align: center;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: #555; transform: translateY(2px); }
        .btn-menu { width: 100%; margin-bottom: 8px; justify-content: space-between; }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 10px; }
        .item-row { border-bottom: 1px solid #444; padding: 12px 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .item-row:hover { background: #222; }
        .item-row.selected { background: #333; border: 1px solid var(--accent); }
        
        .stat-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 5px; }
        .stat-table td { border-bottom: 1px dotted #444; padding: 4px 2px; }
        .stat-table tr:last-child td { border-bottom: none; }
        
        /* Status Tabs */
        .tab-header { display: flex; border-bottom: 1px solid #fff; }
        .tab-btn { flex: 1; padding: 10px 0; text-align: center; background: #222; cursor: pointer; border-right: 1px solid #444; font-size: 12px; }
        .tab-btn.active { background: #555; color: var(--accent); font-weight: bold; }
        .tab-content { display: none; padding: 10px; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        
        /* Profile Image */
        .profile-img { width: 80px; height: 80px; background: #333; border: 2px solid #fff; object-fit: cover; display: block; margin-bottom: 10px; }
        .no-img { display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px; }

        .rarity-N { color: var(--rare-n); } .rarity-R { color: var(--rare-r); }
        .rarity-SR { color: var(--rare-sr); } .rarity-UR { color: var(--rare-ur); }
        .rarity-EX { color: var(--rare-ex); font-weight: bold; text-shadow: 0 0 5px yellow; }

        /* Battle */
        #battle-ui { display: none; flex-direction: column; height: 100%; padding: 5px; }
        #battle-scene { flex: 1; position: relative; display: flex; justify-content: space-around; align-items: center; align-content: center; flex-wrap: wrap; }
        .enemy-sprite { 
            width: 70px; height: 70px; background-size: cover; border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            margin: 2px; position: relative; transition: 0.2s;
        }
        .enemy-sprite.dead { opacity: 0; transform: scale(0.5); }
        .enemy-hp-bar { width: 100%; height: 4px; background: #333; margin-top: 2px; }
        .enemy-hp-val { height: 100%; background: var(--danger); transition: 0.2s; }
        
        #battle-log { flex: 1; overflow-y: auto; font-size: 12px; border: 1px solid #444; padding: 5px; background: rgba(0,0,0,0.5); margin-bottom: 5px; min-height: 80px;}
        #battle-cmd-root, #battle-cmd-sub { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; height: 60px; }
        
        /* Battle Status */
        #party-status-container { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 2px; background:#222; padding:2px; font-size:10px; text-align:center;}
        .p-stat-box { border: 1px solid #444; padding: 4px 2px; height: 70px; display: flex; flex-direction: column; justify-content: space-around; }
        
        #auto-btn { position: absolute; top: 10px; right: 10px; width: 60px; height: 30px; font-size: 12px; z-index: 50; background: #400; opacity: 0.8; }
        #auto-btn.on { background: #d00; border-color: #f88; opacity: 1; box-shadow: 0 0 10px red; }

        #controls { height: 160px; background: #222; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .dpad { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px 50px; gap: 2px; }
        .d-up { grid-column: 2; grid-row: 1; } .d-left { grid-column: 1; grid-row: 2; }
        .d-right { grid-column: 3; grid-row: 2; } .d-down { grid-column: 2; grid-row: 3; }
        .action-pad { display: flex; flex-direction: column; gap: 10px; width: 100px; }
        
        .damage-pop { position: absolute; color: #fff; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000; animation: floatUp 0.8s forwards; pointer-events: none; z-index: 10; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="canvas-wrapper">
        <canvas id="gameCanvas" width="320" height="320"></canvas>
        <div class="ui-layer" id="field-ui">
            <div class="dialog-box" style="width: fit-content; border:none; background:none; text-shadow:1px 1px 0 #000;">
                <span id="loc-name">フィールド</span> <br>
            </div>
            <div class="dialog-box" id="msg-box" style="margin-top:auto; height:80px;">冒険の始まりだ。</div>
        </div>
    </div>

    <!-- Battle Overlay -->
    <div id="battle-ui" class="full-screen-modal" style="background:rgba(0,0,0,1);">
        <button id="auto-btn" class="btn" onclick="Battle.toggleAuto()">AUTO:OFF</button>
        <div id="battle-scene"></div>
        <div id="party-status-container">
            <div id="p-stat-1" class="p-stat-box"></div><div id="p-stat-2" class="p-stat-box"></div>
            <div id="p-stat-3" class="p-stat-box"></div><div id="p-stat-4" class="p-stat-box"></div>
        </div>
        <div id="battle-info" style="height: 180px; display: flex; flex-direction: column;">
            <div id="battle-log"></div>
            <div id="battle-cmd-root">
                <button class="btn" onclick="Battle.onFight()">たたかう</button>
                <button class="btn" onclick="Battle.onRun()">にげる</button>
            </div>
            <div id="battle-cmd-sub" style="display:none; grid-template-columns: 1fr 1fr 1fr; height: 100px;">
                <button class="btn" onclick="Battle.selectAction('attack')">攻撃</button>
                <button class="btn" onclick="Battle.openSkillList('magic')">魔法</button>
                <button class="btn" onclick="Battle.openSkillList('skill')">特技</button>
                <button class="btn" onclick="Battle.openItemList()">道具</button>
                <button class="btn" onclick="Battle.selectAction('guard')">防御</button>
                <button class="btn" style="background:#502020;" onclick="Battle.backToRoot()">戻る</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="dpad">
            <button class="btn d-up" id="btn-up">▲</button>
            <button class="btn d-left" id="btn-left">◀</button>
            <button class="btn d-right" id="btn-right">▶</button>
            <button class="btn d-down" id="btn-down">▼</button>
        </div>
        <div class="action-pad">
            <button class="btn" style="height:50px; background:#404080;" onclick="UI.openMenu()">MENU</button>
            <button class="btn" style="height:50px;" id="btn-ok" onclick="UI.onOk()">決定</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="start-screen" class="full-screen-modal" style="display:flex; justify-content:center; align-items:center;">
        <h1 style="color:var(--accent);">QUEST OF ELEMENTS</h1>
        <p>名前を入力</p>
        <input type="text" id="input-name" placeholder="名前" value="勇者" style="padding:10px; font-size:16px; margin-bottom:10px;">
        <p>画像(任意)</p>
        <input type="file" id="input-file" accept="image/*" style="margin-bottom:20px;">
        <button class="btn" style="width:200px; padding:15px;" onclick="Game.start()">START</button>
    </div>

    <div id="menu-screen" class="full-screen-modal">
        <div style="padding:10px; display:flex; justify-content:space-between; border-bottom:1px solid #fff; align-items:center;">
            <span style="font-size:12px;">G:<span id="menu-gold"></span> GEM:<span id="menu-gem"></span></span>
            <button class="btn" style="width:60px;" onclick="UI.closeMenu()">閉じる</button>
        </div>
        <div class="scroll-area">
            <button class="btn btn-menu" style="background:#400040;" onclick="Dungeon.enter()">ダンジョンへ</button>
            <div class="list-grid">
                <button class="btn" onclick="UI.showStatusList()">ステータス</button>
                <button class="btn" onclick="UI.showEquip()">装備変更</button>
                <button class="btn" onclick="UI.showItems()">道具使用</button>
                <button class="btn" onclick="UI.showPartyForm()">編成</button>
                <button class="btn" onclick="UI.showCharList()">仲間一覧(強化)</button>
                <button class="btn" onclick="UI.showMonsterBook()">魔物図鑑</button>
                <button class="btn" onclick="UI.showGacha()">ガチャ</button>
            </div>
        </div>
    </div>
    
    <div id="sub-screen" class="full-screen-modal" style="background:rgba(0,0,0,0.95); z-index:110;">
        <div style="padding:10px; display:flex; justify-content:space-between; border-bottom:1px solid #fff;">
            <h3 id="sub-title" style="margin:0;">Title</h3>
            <button class="btn" style="width:60px;" onclick="document.getElementById('sub-screen').style.display='none'">戻る</button>
        </div>
        <div id="sub-content" class="scroll-area"></div>
    </div>
    
    <!-- List Modal -->
    <div id="list-modal" class="full-screen-modal" style="background:rgba(0,0,0,0.85); z-index:200;">
        <div class="dialog-box" style="margin:20px; height:80%; display:flex; flex-direction:column;">
            <h3 id="list-title" style="margin:0 0 10px 0;">選択</h3>
            <div id="list-container" class="scroll-area"></div>
            <div id="list-desc" style="min-height:40px; border-top:1px solid #555; font-size:12px; padding:5px; color:#aaa;"></div>
            <button class="btn" style="margin-top:10px;" onclick="UI.closeList()">キャンセル</button>
        </div>
    </div>
</div>

<script>
/* ==========================================================================
   MASTER DATA
   ========================================================================== */
const CONST = {
    ELEMENTS: ['火', '水', '風', '雷', '光', '闇', '混沌'],
    PARTS: ['武器', '盾', '頭', '体', '足'],
    JOB_SKILLS: {
        '勇者': { 1:['強打'], 3:['ホイミ'], 5:['火炎斬り'], 10:['ベホイミ'], 15:['ギガデイン'], 30:['ギガブレイク'] },
        '戦士': { 1:['強打'], 5:['兜割り'], 10:['五月雨突き'], 20:['魔神斬り'], 30:['覇王の一閃'] },
        '魔法使い': { 1:['メラ'], 5:['ヒャド'], 10:['イオ'], 15:['バイキルト'], 20:['メラゾーマ'], 30:['メラガイアー'] },
        '僧侶': { 1:['ホイミ'], 5:['スカラ'], 12:['ベホイミ'], 20:['ザオラル'], 30:['ベホマラー'] },
        '賢者': { 1:['ホイミ','メラ'], 10:['ベホイミ','ヒャド'], 20:['ザオリク','イオナズン'], 35:['ビッグバン'] },
        '遊び人': { 1:['口笛'], 10:['石つぶて'], 20:['パルプンテ'] }
    }
};

const DB = {
    SKILLS: [
        {id:1, name:'こうげき', type:'物理', target:'単体', mp:0, elm:null, rate:1.0, count:1, base:0, desc:'武器による直接攻撃'},
        {id:2, name:'強打', type:'物理', target:'単体', mp:2, elm:null, rate:1.2, count:1, base:5, desc:'力を込めた強力な一撃'},
        {id:3, name:'火炎斬り', type:'物理', target:'単体', mp:4, elm:'火', rate:1.3, count:1, base:10, desc:'炎をまとった剣技'},
        {id:4, name:'兜割り', type:'物理', target:'単体', mp:4, elm:null, rate:1.1, count:1, base:0, desc:'攻撃と同時に守備力を下げる'},
        {id:5, name:'五月雨突き', type:'物理', target:'ランダム', mp:8, elm:null, rate:0.5, count:4, base:0, desc:'ランダムな敵に4回攻撃'},
        {id:6, name:'魔神斬り', type:'物理', target:'単体', mp:12, elm:null, rate:2.5, count:1, base:0, desc:'ミスしやすいが当たれば会心'},
        {id:7, name:'ギガデイン', type:'魔法', target:'全体', mp:30, elm:'雷', rate:1.0, count:1, base:150, desc:'敵全体を雷光で焼き尽くす'},
        {id:8, name:'ギガブレイク', type:'物理', target:'単体', mp:25, elm:'雷', rate:2.5, count:1, base:100, desc:'雷の力を宿した究極剣技'},
        {id:10, name:'メラ', type:'魔法', target:'単体', mp:2, elm:'火', rate:1.0, count:1, base:15, desc:'小さな火の玉を放つ'},
        {id:13, name:'メラゾーマ', type:'魔法', target:'単体', mp:15, elm:'火', rate:1.0, count:1, base:100, desc:'巨大な火球で焼き尽くす'},
        {id:14, name:'メラガイアー', type:'魔法', target:'単体', mp:45, elm:'火', rate:1.0, count:1, base:300, desc:'全てを灰にする地獄の業火'},
        {id:20, name:'ホイミ', type:'回復', target:'単体', mp:3, elm:null, rate:0.5, count:1, base:30, desc:'仲間のHPを少し回復'},
        {id:21, name:'ベホイミ', type:'回復', target:'単体', mp:6, elm:null, rate:1.0, count:1, base:80, desc:'仲間のHPを中回復'},
        {id:22, name:'ベホマラー', type:'回復', target:'全体', mp:18, elm:null, rate:0.8, count:1, base:100, desc:'味方全員のHPを回復'},
        {id:30, name:'ザオラル', type:'蘇生', target:'単体', mp:10, elm:null, rate:0.5, count:1, base:0, desc:'50%の確率で仲間を生き返らせる'},
        {id:31, name:'ザオリク', type:'蘇生', target:'単体', mp:30, elm:null, rate:1.0, count:1, base:0, desc:'仲間を確実に生き返らせる'},
        {id:40, name:'バイキルト', type:'強化', target:'単体', mp:8, elm:null, rate:0, count:1, base:0, buff:{atk:1.5}, desc:'攻撃力を一時的に1.5倍にする'},
        {id:41, name:'スカラ', type:'強化', target:'単体', mp:4, elm:null, rate:0, count:1, base:0, buff:{def:1.5}, desc:'守備力を一時的に1.5倍にする'},
        {id:99, name:'石つぶて', type:'物理', target:'全体', mp:0, elm:null, rate:0.5, count:1, base:5, desc:'敵全体に小石を投げる'}
    ],
    ITEMS: [
        {id:1, name:'やくそう', type:'HP回復', val:400, desc:'HPを300～500回復'},
        {id:2, name:'上やくそう', type:'HP回復', val:1000, desc:'HPを800～1200回復'},
        {id:3, name:'特やくそう', type:'HP回復', val:3000, desc:'HPを2800～3500回復'},
        {id:4, name:'世界樹の雫', type:'HP回復', val:9999, desc:'味方全体のHPを全回復', target:'全体'},
        {id:5, name:'魔法の小瓶', type:'MP回復', val:100, desc:'MPを80～120回復'},
        {id:6, name:'魔法の聖水', type:'MP回復', val:500, desc:'MPを400～600回復'},
        {id:7, name:'賢者の聖水', type:'MP回復', val:2000, desc:'MPを1800～2000回復'},
        {id:8, name:'エルフの飲み薬', type:'MP回復', val:9999, desc:'MPを全回復'}
    ],
    MONSTERS: [
        {id:1, name:'スライム', hp:8, mp:0, atk:8, mag:0, def:2, spd:3, exp:10, gold:10, gem:30, dropRate:24, acts:[1]},
        {id:2, name:'おおがらす', hp:36, mp:0, atk:28, mag:0, def:20, spd:10, exp:20, gold:20, gem:50, dropRate:10, acts:[1]},
        {id:26, name:'Gスライム', hp:2000, mp:9999, atk:500, mag:2000, def:5000, spd:1999, exp:100000, gold:100000, gem:30000, dropRate:100, acts:[1,10,13,14,7]}
    ],
    EQUIPS: [
        {id:1, name:'どうのつるぎ', type:'武器', atk:15, val:1000},
        {id:2, name:'はがねのつるぎ', type:'武器', atk:30, val:10000},
        {id:3, name:'ロトのつるぎ', type:'武器', atk:80, elmAtk:{'火':100}, val:1000000},
        {id:6, name:'天空のつるぎ', type:'武器', atk:300, elmAtk:{'雷':250, '光':250}, bonus:{finDmg:0.1}, val:99999999},
        {id:7, name:'かわの盾', type:'盾', def:20, val:1000},
        {id:8, name:'てつの盾', type:'盾', def:50, val:10000},
        {id:9, name:'ロトの盾', type:'盾', def:50, spd:110, val:1000000},
        {id:11, name:'天空の盾', type:'盾', def:210, bonus:{magDmg:1}, val:50000000},
        {id:13, name:'かわのぼうし', type:'頭', def:10, val:500},
        {id:14, name:'てつかぶと', type:'頭', def:25, val:5000},
        {id:19, name:'ぬののふく', type:'体', def:15, val:500},
        {id:20, name:'はがねのよろい', type:'体', def:40, val:5000},
        {id:25, name:'かわのくつ', type:'足', spd:5, val:200},
        {id:26, name:'てつのあしく', type:'足', spd:15, val:2000}
    ],
    OPTION_RULES: [
        {key:'hp', name:'HP増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'mp', name:'MP増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'atk', name:'攻撃力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'def', name:'防御力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'spd', name:'素早さ増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'mag', name:'魔法攻撃力増', unit:'val', allowed:['N','R','SR','UR']},
        {key:'elmAtk', name:'属性攻撃増', unit:'val', allowed:['UR','EX']},
        {key:'elmRes', name:'属性耐性増', unit:'val', allowed:['UR','EX']},
        {key:'magDmg', name:'魔法ダメージ増', unit:'%', allowed:['UR','EX']},
        {key:'sklDmg', name:'特技ダメージ増', unit:'%', allowed:['UR','EX']},
        {key:'finDmg', name:'最終与ダメージ増', unit:'%', allowed:['EX']},
        {key:'finRed', name:'最終被ダメージ減', unit:'%', allowed:['EX']},
        {key:'mpRed', name:'MP消費減', unit:'%', allowed:['EX']}
    ]
};

const rand = (n) => Math.floor(Math.random() * n);

/* ==========================================================================
   GAME CLASSES
   ========================================================================== */
class Entity {
    constructor(name, hp, mp, atk, def, spd, mag) {
        this.name = name;
        this.maxHp = hp; this.hp = hp;
        this.maxMp = mp; this.mp = mp;
        this.baseStats = { atk, def, spd, mag };
        this.buffs = { atk:1, def:1, spd:1, mag:1 }; 
        this.isDead = false;
        this.elmAtk = {}; this.elmRes = {};
        CONST.ELEMENTS.forEach(e => { this.elmAtk[e]=0; this.elmRes[e]=0; });
        this.bonuses = { magDmg:0, sklDmg:0, finDmg:0, finRed:0, mpRed:0 };
    }
    getStat(key) {
        let val = this.baseStats[key] || 0;
        if(this.buffs[key]) val *= this.buffs[key];
        return Math.floor(val);
    }
}

class Player extends Entity {
    constructor(name, job, img, rarity='N') {
        const mult = ['N','R','SR','UR','EX'].indexOf(rarity) + 1;
        super(name, 30*mult, 10*mult, 10*mult, 10*mult, 10*mult, 10*mult);
        this.id = Date.now() + Math.random();
        this.job = job; this.rarity = rarity; this.img = img;
        this.level = 1; this.exp = 0;
        this.count = 1; this.limitBreak = 0;
        this.equips = { 武器:null, 盾:null, 頭:null, 体:null, 足:null };
        this.skills = [];
        this.learnSkills();
    }

    getStat(key) {
        let val = this.baseStats[key] || 0;
        val = val * (1 + this.limitBreak * 0.1);
        
        let flat = 0;
        for(let p of CONST.PARTS) {
            const eq = this.equips[p];
            if(eq) {
                if(eq.data[key]) flat += eq.data[key];
                eq.opts.forEach(o => {
                    if(o.key === key && o.unit === 'val') flat += o.val;
                });
            }
        }
        val += flat;
        
        if(this.buffs[key]) val *= this.buffs[key];
        return Math.floor(val);
    }

    refreshBonuses() {
        this.bonuses = { magDmg:0, sklDmg:0, finDmg:0, finRed:0, mpRed:0 };
        CONST.ELEMENTS.forEach(e => { this.elmAtk[e]=0; this.elmRes[e]=0; });

        for(let p of CONST.PARTS) {
            const eq = this.equips[p];
            if(eq) {
                if(eq.data.elmAtk) Object.keys(eq.data.elmAtk).forEach(k => this.elmAtk[k] += eq.data.elmAtk[k]);
                if(eq.data.bonus) Object.keys(eq.data.bonus).forEach(k => this.bonuses[k] += eq.data.bonus[k]);

                eq.opts.forEach(o => {
                    if(o.key === 'elmAtk') this.elmAtk[o.elm] += o.val;
                    if(o.key === 'elmRes') this.elmRes[o.elm] += o.val;
                    if(this.bonuses[o.key] !== undefined && o.unit === '%') this.bonuses[o.key] += o.val;
                });
            }
        }
    }

    learnSkills() {
        const map = CONST.JOB_SKILLS[this.job];
        if(!map) return;
        for(let lv=1; lv<=this.level; lv++) {
            if(map[lv]) {
                map[lv].forEach(sName => {
                    const sk = DB.SKILLS.find(s=>s.name===sName);
                    if(sk && !this.skills.some(s=>s.id===sk.id)) this.skills.push(sk);
                });
            }
        }
    }
    
    addExp(val) {
        this.exp += val;
        const next = this.level * 100;
        if(this.exp >= next) {
            this.level++;
            this.exp -= next;
            this.maxHp += 15; this.maxMp += 8;
            Object.keys(this.baseStats).forEach(k => this.baseStats[k] += 4);
            this.learnSkills();
            return true;
        }
        return false;
    }
}

class Equipment {
    constructor() {
        this.id = Date.now() + Math.random();
        this.part = CONST.PARTS[rand(CONST.PARTS.length)];
        
        const cands = DB.EQUIPS.filter(e => e.type === this.part);
        this.data = cands[rand(cands.length)] || cands[0];
        this.type = this.data.type;
        
        const r = Math.random();
        let optNum = 0;
        if(r < 0.5) optNum=0; else if(r < 0.8) optNum=1; else if(r < 0.95) optNum=2; else optNum=3;
        
        this.opts = [];
        for(let i=0; i<optNum; i++) this.addOption();
        
        this.name = `${this.data.name}${optNum > 0 ? ' +'+optNum : ''}`;
    }
    
    addOption() {
        const r = Math.random()*100;
        let rarity = r<50?'N':(r<80?'R':(r<94?'SR':(r<99?'UR':'EX')));
        const available = DB.OPTION_RULES.filter(rule => rule.allowed.includes(rarity));
        if(available.length === 0) return;
        
        const rule = available[rand(available.length)];
        const opt = { key: rule.key, name: rule.name, unit: rule.unit, rarity: rarity };
        
        if(rule.key === 'elmAtk' || rule.key === 'elmRes') {
            opt.elm = CONST.ELEMENTS[rand(CONST.ELEMENTS.length)];
            opt.val = (CONST.ELEMENTS.indexOf(rarity)+1) * 10 + rand(10); 
            opt.label = `${opt.elm}${rule.name}`;
        } else {
            if(rule.unit === 'val') {
                let base = 5;
                if(rule.key === 'hp' || rule.key === 'mp') base = 50;
                const mult = ['N','R','SR','UR','EX'].indexOf(rarity) + 1;
                opt.val = base * mult + rand(base);
            } else {
                const mult = ['N','R','SR','UR','EX'].indexOf(rarity) + 1;
                opt.val = 0.05 * mult; 
            }
            opt.label = rule.name;
        }
        this.opts.push(opt);
    }
}

class Monster extends Entity {
    constructor(data) {
        super(data.name, data.hp, data.mp, data.atk, data.def, data.spd, data.mag);
        this.data = data;
    }
}

/* ==========================================================================
   GAME STATE
   ========================================================================== */
const Game = {
    allCharacters: [],
    party: [null, null, null, null],
    items: {}, 
    inventory: [],
    book: { monsters:[] },
    gold: 1000, gems: 3000,
    
    start: () => {
        const name = document.getElementById('input-name').value;
        const file = document.getElementById('input-file').files[0];
        
        const init = (img) => {
            const hero = new Player(name, '勇者', img, 'SR');
            Game.allCharacters.push(hero);
            Game.allCharacters.push(new Player('アリア', '魔法使い', null, 'R'));
            Game.allCharacters.push(new Player('ライアン', '戦士', null, 'N'));
            Game.allCharacters.push(new Player('クリフト', '僧侶', null, 'N'));
            
            Game.party[0] = Game.allCharacters[0];
            Game.party[1] = Game.allCharacters[1];
            Game.party[2] = Game.allCharacters[2];
            Game.party[3] = Game.allCharacters[3];

            Game.addItem(1, 5); 
            Game.addItem(5, 2); 
            
            Game.addEquip(new Equipment());
            Game.addEquip(new Equipment());

            document.getElementById('start-screen').style.display = 'none';
            Dungeon.initField();
            UI.render();
        };

        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => init(e.target.result);
            reader.readAsDataURL(file);
        } else {
            init(null);
        }
    },

    addItem: (id, count=1) => {
        if(!Game.items[id]) Game.items[id] = 0;
        Game.items[id] += count;
    },
    useItem: (id) => {
        if(Game.items[id] > 0) {
            Game.items[id]--;
            return true;
        }
        return false;
    },
    addEquip: (eq) => {
        Game.inventory.push(eq);
    }
};

const Dungeon = {
    w: 30, h: 30, map: [], px: 15, py: 15,
    inDungeon: false, floor: 0,
    
    initField: () => {
        Dungeon.inDungeon = false; Dungeon.floor = 0;
        document.getElementById('loc-name').innerText = "フィールド";
        Dungeon.map = []; 
        for(let y=0; y<Dungeon.h; y++) {
            Dungeon.map[y] = [];
            for(let x=0; x<Dungeon.w; x++) {
                Dungeon.map[y][x] = Math.random()<0.1 ? 2 : (Math.random()<0.2 ? 1 : 0);
                if(x===0||x===Dungeon.w-1||y===0||y===Dungeon.h-1) Dungeon.map[y][x] = 2;
            }
        }
        Dungeon.px=15; Dungeon.py=15;
    },
    enter: () => { UI.closeMenu(); Dungeon.inDungeon = true; Dungeon.floor = 0; Dungeon.nextFloor(); },
    nextFloor: () => {
        Dungeon.floor++;
        document.getElementById('loc-name').innerText = `ダンジョン B${Dungeon.floor}`;
        UI.msg(`地下${Dungeon.floor}階へ降りた`);
        Dungeon.generateWormhole();
        UI.render();
    },
    generateWormhole: () => {
        Dungeon.map = [];
        for(let y=0; y<Dungeon.h; y++) Dungeon.map[y] = new Array(Dungeon.w).fill(1); // 壁
        let cx = 15, cy = 15;
        Dungeon.map[cy][cx] = 0; Dungeon.px = cx; Dungeon.py = cy;
        const digCount = 400 + rand(200);
        for(let i=0; i<digCount; i++) {
            const dir = rand(4);
            let dx=0, dy=0;
            if(dir===0) dy=-1; if(dir===1) dx=1; if(dir===2) dy=1; if(dir===3) dx=-1;
            if(cy+dy*2>0 && cy+dy*2<Dungeon.h-1 && cx+dx*2>0 && cx+dx*2<Dungeon.w-1) {
                 Dungeon.map[cy+dy][cx+dx] = 0; cy += dy; cx += dx; Dungeon.map[cy][cx] = 0;
            }
        }
        let sx=0, sy=0;
        while(Dungeon.map[sy][sx]!==0 || (sx===Dungeon.px && sy===Dungeon.py)) { sx=rand(Dungeon.w); sy=rand(Dungeon.h); }
        Dungeon.map[sy][sx] = 2; // 階段
        if(rand(100) < 40) { 
            let tx=0, ty=0;
            while(Dungeon.map[ty][tx]!==0) { tx=rand(Dungeon.w); ty=rand(Dungeon.h); }
            Dungeon.map[ty][tx] = 3; 
        }
    },
    move: (dx, dy) => {
        if(Battle.active) return;
        const nx = Dungeon.px + dx; const ny = Dungeon.py + dy;
        if(nx<0 || nx>=Dungeon.w || ny<0 || ny>=Dungeon.h) return;
        const tile = Dungeon.map[ny] ? Dungeon.map[ny][nx] : 1;
        if(tile === 1 || tile === 2 && !Dungeon.inDungeon) { UI.msg("進めない"); return; }
        Dungeon.px = nx; Dungeon.py = ny;
        UI.render();
        if(Dungeon.inDungeon && tile === 2) { if(confirm("降りますか？")) Dungeon.nextFloor(); return; }
        if(Dungeon.inDungeon && tile === 3) { Dungeon.openChest(nx, ny); return; }
        const rate = Dungeon.inDungeon ? 0.08 : 0.05;
        if(Math.random() < rate) Battle.start();
    },
    openChest: (x, y) => {
        Dungeon.map[y][x] = 0;
        UI.render();
        if(rand(100) < 50) {
            const itm = DB.ITEMS[rand(DB.ITEMS.length)];
            Game.addItem(itm.id, 1);
            alert(`${itm.name}を手に入れた！`);
        } else {
            const eq = new Equipment();
            Game.addEquip(eq);
            alert(`${eq.name}を手に入れた！`);
        }
    }
};

/* ==========================================================================
   BATTLE SYSTEM
   ========================================================================== */
const Battle = {
    active: false,
    auto: false,
    enemies: [],
    currActorIdx: 0,
    playerActions: [],

    toggleAuto: () => {
        Battle.auto = !Battle.auto;
        const btn = document.getElementById('auto-btn');
        btn.innerText = `AUTO:${Battle.auto?'ON':'OFF'}`;
        btn.className = `btn ${Battle.auto?'on':''}`;
        if(Battle.auto && document.getElementById('battle-cmd-root').style.display !== 'none') {
            Battle.onFight();
        }
    },

    start: () => {
        Battle.active = true;
        document.getElementById('battle-ui').style.display = 'flex';
        document.getElementById('field-ui').style.display = 'none';
        Battle.enemies = [];
        
        Game.party.forEach(p => { if(p) p.refreshBonuses(); });

        const floorFactor = Math.floor(Dungeon.floor / 5);
        const num = 1 + rand(Dungeon.inDungeon ? 3 : 2);
        
        if(Dungeon.inDungeon && Dungeon.floor % 10 === 0 && Dungeon.floor > 0) {
            const boss = new Monster(DB.MONSTERS.find(m=>m.name.includes('ドラゴン')||m.name.includes('魔王'))); // Fallback
            if(boss) boss.hp *= (1 + Dungeon.floor * 0.1);
            Battle.enemies.push(boss || new Monster(DB.MONSTERS[0]));
        } else {
            const list = DB.MONSTERS.filter(m => !m.name.includes('ドラゴン') && !m.name.includes('魔王'));
            for(let i=0; i<num; i++) {
                const base = list[Math.min(list.length-1, rand(list.length) + Math.min(2, floorFactor))];
                const m = new Monster(base);
                m.hp = Math.floor(m.hp * (1 + Dungeon.floor * 0.05));
                m.atk = Math.floor(m.atk * (1 + Dungeon.floor * 0.05));
                m.name += String.fromCharCode(65+i);
                Battle.enemies.push(m);
            }
        }
        Battle.log("モンスターが現れた！");
        Battle.refreshView();
        Battle.onRootPhase();
    },

    onRootPhase: () => {
        if(Battle.auto) { Battle.onFight(); return; }
        document.getElementById('battle-cmd-root').style.display = 'grid';
        document.getElementById('battle-cmd-sub').style.display = 'none';
        Battle.log("コマンド？");
    },
    
    onFight: () => {
        document.getElementById('battle-cmd-root').style.display = 'none';
        document.getElementById('battle-cmd-sub').style.display = Battle.auto ? 'none' : 'grid';
        Battle.currActorIdx = 0;
        Battle.playerActions = [];
        Battle.nextInput();
    },
    
    nextInput: () => {
        while(Battle.currActorIdx < Game.party.length) {
            const p = Game.party[Battle.currActorIdx];
            if(p && p.hp > 0) {
                if(Battle.auto) {
                    const t = Battle.enemies.filter(e=>e.hp>0);
                    if(t.length>0) Battle.playerActions.push({actor:p, skill:DB.SKILLS[0], targets:[t[rand(t.length)]]});
                    Battle.currActorIdx++;
                } else {
                    Battle.log(`${p.name} の行動`);
                    return; 
                }
            } else {
                Battle.currActorIdx++;
            }
        }
        Battle.executeTurn();
    },
    
    backToRoot: () => {
        if(Battle.currActorIdx === 0) Battle.onRootPhase();
        else {
            Battle.currActorIdx--;
            while(Battle.currActorIdx > 0 && (!Game.party[Battle.currActorIdx] || Game.party[Battle.currActorIdx].hp <= 0)) {
                Battle.currActorIdx--;
            }
            Battle.playerActions.pop();
            Battle.nextInput();
        }
    },

    selectAction: (type) => {
        const actor = Game.party[Battle.currActorIdx];
        if(type==='attack') Battle.selectTarget(DB.SKILLS[0], t=>Battle.commit(actor, DB.SKILLS[0], t));
        if(type==='guard') Battle.commit(actor, {name:'防御',type:'防御',speed:9999}, actor);
    },

    openSkillList: (cat) => {
        const actor = Game.party[Battle.currActorIdx];
        const list = actor.skills.filter(s => cat==='magic' ? ['魔法','回復','蘇生'].includes(s.type) : ['物理','強化','特殊'].includes(s.type));
        UI.showList(list, sk => {
            let cost = sk.mp;
            if(actor.bonuses && actor.bonuses.mpRed) cost = Math.floor(cost * (1 - actor.bonuses.mpRed));
            if(actor.mp < cost) { UI.msg("MP不足"); return false; }
            Battle.selectTarget(sk, t=>Battle.commit(actor, sk, t));
            return true;
        }, true);
    },

    openItemList: () => {
        const actor = Game.party[Battle.currActorIdx];
        const list = Object.keys(Game.items).map(id => {
            const meta = DB.ITEMS.find(i=>i.id==parseInt(id));
            return { ...meta, count: Game.items[id], isItem: true };
        }).filter(i => i.count > 0);
        
        if(list.length===0) { UI.msg("道具がない"); return; }
        
        UI.showList(list, itm => {
            Battle.selectTarget(itm, t => {
                const sk = { name:itm.name, type:itm.type, val:itm.val, speed:9999, isItem:true, id:itm.id, target:itm.target };
                Battle.commit(actor, sk, t);
            });
            return true;
        }, true);
    },

    selectTarget: (sk, cb) => {
        let list = [];
        if(['HP回復','MP回復','回復','強化','蘇生'].includes(sk.type)) {
             list = Game.party.filter(p => p !== null); 
             if(sk.type==='蘇生') list = list.filter(p => p.hp <= 0);
        } else {
            list = Battle.enemies.filter(e => e.hp > 0);
        }
        
        if(list.length === 0) { UI.msg("対象がいません"); return; }

        if(sk.target==='全体'||sk.target==='ランダム'||(sk.isItem && sk.target==='全体')) {
            cb(list);
        } else if(sk.target==='自分') {
            cb([Game.party[Battle.currActorIdx]]);
        } else {
            UI.showList(list, t => { cb([t]); return true; }, false);
        }
    },

    commit: (actor, skill, targets) => {
        Battle.playerActions.push({ actor, skill, targets });
        Battle.currActorIdx++;
        Battle.nextInput();
    },

    onRun: () => {
        if(rand(100) < 50) { Battle.log("逃げ出した！"); setTimeout(Battle.end, 1000); }
        else { Battle.log("回り込まれた！"); Battle.playerActions = []; Battle.executeTurn(); }
    },

    executeTurn: async () => {
        document.getElementById('battle-cmd-sub').style.display = 'none';
        
        let queue = [...Battle.playerActions];
        Battle.enemies.forEach(e => {
            if(e.hp>0) {
                const actId = e.data.acts[rand(e.data.acts.length)];
                let sk = DB.SKILLS.find(s=>s.id===actId) || DB.SKILLS[0];
                const validTargets = Game.party.filter(p=>p&&p.hp>0);
                if(validTargets.length>0) {
                    let targets = [validTargets[rand(validTargets.length)]];
                    if(sk.target==='全体') targets = validTargets;
                    queue.push({ actor:e, skill:sk, targets });
                }
            }
        });

        queue.forEach(q => q.speed = q.skill.speed || (q.actor.getStat('spd') * (0.8+Math.random()*0.4)));
        queue.sort((a,b) => b.speed - a.speed);

        for(let act of queue) {
            if(!Battle.active) break;
            const user = act.actor;
            if(user.hp <= 0) continue;

            const sk = act.skill;
            
            if(sk.mp > 0) {
                let cost = sk.mp;
                if(user.bonuses && user.bonuses.mpRed) cost = Math.floor(cost * (1 - user.bonuses.mpRed));
                user.mp -= cost;
            }
            if(sk.isItem) {
                if(Game.items[sk.id] > 0) Game.items[sk.id]--;
                else continue;
            }

            let targets = Array.isArray(act.targets) ? act.targets : [act.targets];
            targets = targets.filter(t => sk.type==='蘇生' ? t.hp<=0 : t.hp>0);
            if(targets.length === 0) continue;

            Battle.log(`${user.name}の${sk.name}！`);
            await UI.wait(400);

            if(sk.type==='防御') continue;

            for(let t of targets) {
                let dmg = 0;
                let isHeal = ['回復','蘇生','HP回復','MP回復'].includes(sk.type);
                
                if(isHeal) {
                    if(sk.type==='蘇生') {
                        if(Math.random()<sk.rate) { t.hp = Math.floor(t.maxHp*0.5); t.isDead = false; Battle.log(`${t.name}は生き返った`); }
                        else Battle.log("ミス！");
                    } else if(sk.type==='MP回復') {
                        let rec = Math.floor((sk.val || 0) * (0.9+Math.random()*0.2));
                        t.mp = Math.min(t.maxMp, t.mp + rec);
                        Battle.log(`${t.name}のMPが ${rec} 回復`);
                        UI.showDamage(t, rec, '#88f');
                    } else {
                        let base = sk.val ? sk.val : (user.getStat('mag')+sk.base)*sk.rate;
                        let rec = Math.floor(base * (0.9+Math.random()*0.2));
                        t.hp = Math.min(t.maxHp, t.hp + rec);
                        Battle.log(`${t.name}のHPが ${rec} 回復`);
                        UI.showDamage(t, rec, '#4f4');
                    }
                } else if(sk.type==='強化') {
                    if(sk.buff) Object.keys(sk.buff).forEach(k => t.buffs[k] = sk.buff[k]);
                    Battle.log(`${t.name}の能力が上がった`);
                } else {
                    let atk = user.getStat(sk.type==='物理'?'atk':'mag');
                    let def = t.getStat('def');
                    
                    let base = ((atk+sk.base)*sk.rate) - (sk.type==='物理'?def/2:0);
                    if(sk.elm) base += (user.elmAtk[sk.elm]||0) - (t.elmRes[sk.elm]||0);
                    
                    let mul = 1.0;
                    if(user.bonuses) {
                        if(sk.type==='魔法') mul += user.bonuses.magDmg;
                        if(sk.type==='物理' && sk.name!=='こうげき') mul += user.bonuses.sklDmg;
                        mul += user.bonuses.finDmg;
                    }
                    base *= mul;
                    
                    if(t.bonuses && t.bonuses.finRed) base *= (1 - t.bonuses.finRed);

                    let dmg = Math.max(1, Math.floor(base * (0.8+Math.random()*0.4)));
                    
                    for(let i=0; i<sk.count; i++) {
                        t.hp -= dmg;
                        UI.showDamage(t, dmg);
                        Battle.log(`${t.name}に ${dmg} のダメージ`);
                        if(t.hp<=0) { t.hp=0; t.isDead=true; Battle.log(`${t.name}は倒れた`); break; }
                        await UI.wait(150);
                    }
                }
            }
            Battle.refreshView();
            
            if(Battle.enemies.every(e=>e.hp<=0)) { await Battle.win(); return; }
            const liveParty = Game.party.filter(p=>p&&p.hp>0);
            if(liveParty.length===0) { Battle.lose(); return; }
            await UI.wait(300);
        }
        Battle.onRootPhase();
    },

    win: async () => {
        Battle.log("勝利！");
        await UI.wait(1000);
        let exp=0, gold=0, gem=0;
        
        Battle.enemies.forEach(e => {
            exp += e.data.exp; gold += e.data.gold; gem += (e.data.gem || 0);
            if(!Game.book.monsters.includes(e.data.id)) Game.book.monsters.push(e.data.id);
            if(rand(100) < e.data.dropRate) {
                const item = new Equipment();
                Game.addEquip(item);
                Battle.log(`${item.name}を入手`);
            }
        });
        
        Game.gold += gold; Game.gems += gem;
        Battle.log(`${exp}EXP ${gold}G ${gem}GEM 入手`);
        Game.party.forEach(p => { if(p && p.hp>0 && p.addExp(exp)) Battle.log(`${p.name} LvUP!`); });
        
        await UI.wait(1000);
        Battle.end();
    },

    lose: () => {
        Battle.log("全滅...");
        setTimeout(() => location.reload(), 2000);
    },

    end: () => {
        Battle.active = false;
        document.getElementById('battle-ui').style.display = 'none';
        document.getElementById('field-ui').style.display = 'flex';
        Game.party.forEach(p => { if(p) p.buffs = {atk:1, def:1, spd:1, mag:1}; });
        UI.render();
    },

    log: (msg) => {
        const d = document.getElementById('battle-log');
        d.innerHTML += `<div>${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    },

    refreshView: () => {
        const sc = document.getElementById('battle-scene');
        sc.innerHTML = '';
        Battle.enemies.forEach(e => {
            const d = document.createElement('div');
            d.className = `enemy-sprite ${e.hp<=0?'dead':''}`;
            d.style.background = e.data.id >= 10 ? '#800' : '#444'; 
            d.innerHTML = `<span style="font-size:10px; text-shadow:1px 1px 0 #000;">${e.name}</span>
            <div class="enemy-hp-bar"><div class="enemy-hp-val" style="width:${(e.hp/e.maxHp)*100}%"></div></div>`;
            sc.appendChild(d);
        });
        for(let i=0; i<4; i++) {
            const p = Game.party[i];
            const div = document.getElementById(`p-stat-${i+1}`);
            div.innerHTML = p ? 
            `<div>${p.name}</div>
             <div>HP ${p.hp}/${p.maxHp}</div>
             <div>MP ${p.mp}/${p.maxMp}</div>
             <div>Lv.${p.level}</div>` : '-';
        }
    }
};

/* ==========================================================================
   UI CONTROLLERS
   ========================================================================== */
const UI = {
    canvas: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    
    msg: (t) => document.getElementById('msg-box').innerText = t,
    
    render: () => {
        const ctx = UI.ctx;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,320,320);
        
        if (!Dungeon.map || Dungeon.map.length === 0) return;

        const ts = 32;
        const cx = Dungeon.px-5; const cy = Dungeon.py-5;
        for(let y=0; y<11; y++) {
            for(let x=0; x<11; x++) {
                const mx=cx+x, my=cy+y;
                if(mx>=0 && mx<Dungeon.w && my>=0 && my<Dungeon.h) {
                    if (Dungeon.map[my]) {
                        const t = Dungeon.map[my][mx];
                        if(t===0) ctx.fillStyle = '#444'; 
                        else if(t===1) ctx.fillStyle = '#000'; 
                        else if(t===2) ctx.fillStyle = '#aaa'; 
                        else if(t===3) ctx.fillStyle = '#dd0'; 
                        if(!Dungeon.inDungeon) { if(t===0) ctx.fillStyle='#282'; if(t===2) ctx.fillStyle='#228'; }
                        ctx.fillRect(x*ts, y*ts, ts, ts);
                        ctx.strokeStyle='#222'; ctx.strokeRect(x*ts, y*ts, ts, ts);
                        if(t===2 && Dungeon.inDungeon) { ctx.fillStyle='#fff'; ctx.fillText('▼', x*ts+10, y*ts+20); }
                        if(t===3 && Dungeon.inDungeon) { ctx.fillStyle='#000'; ctx.fillText('箱', x*ts+10, y*ts+20); }
                    }
                }
            }
        }
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(5*ts+16, 5*ts+16, 10, 0, Math.PI*2); ctx.fill();
    },

    openMenu: () => {
        if(Battle.active) return;
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('menu-gold').innerText = Game.gold;
        document.getElementById('menu-gem').innerText = Game.gems;
    },
    closeMenu: () => { document.getElementById('menu-screen').style.display = 'none'; },

    showStatusList: () => {
        UI.showList(Game.allCharacters, (char) => {
            UI.showStatusDetail(char);
            return false; // Keep list open logic handled by showStatusDetail
        }, false);
    },

    showStatusDetail: (p) => {
        p.refreshBonuses();
        
        const makeTab = (id, label, active) => `<div class="tab-btn ${active?'active':''}" onclick="UI.switchStatusTab('${id}')">${label}</div>`;
        const makeContent = (id, content, active) => `<div id="tab-${id}" class="tab-content ${active?'active':''}" style="height:250px; overflow-y:auto;">${content}</div>`;

        // Tab 1: Basic
        let eqList = CONST.PARTS.map(part => {
            const eq = p.equips[part];
            return `<div>${part}: ${eq ? eq.name : '-'}</div>`;
        }).join('');
        
        let t1 = `
            <div style="display:flex; gap:10px;">
                ${p.img ? `<img src="${p.img}" class="profile-img">` : `<div class="profile-img no-img">NO IMG</div>`}
                <div>
                    <div style="font-size:16px; font-weight:bold;">${p.name}</div>
                    <div>${p.job} (★${p.rarity})</div>
                </div>
            </div>
            <div style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">${eqList}</div>
        `;

        // Tab 2: Base Stats
        let t2 = `
            <table class="stat-table">
                <tr><td>Lv</td><td>${p.level}</td></tr>
                <tr><td>HP</td><td>${p.hp} / ${p.maxHp}</td></tr>
                <tr><td>MP</td><td>${p.mp} / ${p.maxMp}</td></tr>
                <tr><td>攻撃力</td><td>${p.getStat('atk')}</td></tr>
                <tr><td>防御力</td><td>${p.getStat('def')}</td></tr>
                <tr><td>素早さ</td><td>${p.getStat('spd')}</td></tr>
                <tr><td>魔攻</td><td>${p.getStat('mag')}</td></tr>
            </table>
        `;

        // Tab 3: Advanced
        let elms = CONST.ELEMENTS.map(e => `<tr><td>${e}</td><td>攻:${p.elmAtk[e]} / 耐:${p.elmRes[e]}</td></tr>`).join('');
        let t3 = `
            <table class="stat-table">
                ${elms}
                <tr><td>魔ダメ増</td><td>${Math.floor(p.bonuses.magDmg*100)}%</td></tr>
                <tr><td>特技ダメ増</td><td>${Math.floor(p.bonuses.sklDmg*100)}%</td></tr>
                <tr><td>最終与ダメ増</td><td>${Math.floor(p.bonuses.finDmg*100)}%</td></tr>
                <tr><td>最終被ダメ減</td><td>${Math.floor(p.bonuses.finRed*100)}%</td></tr>
                <tr><td>MP消費減</td><td>${Math.floor(p.bonuses.mpRed*100)}%</td></tr>
            </table>
        `;

        // Tab 4: Magic
        const magics = p.skills.filter(s => ['魔法','回復','蘇生'].includes(s.type));
        let t4 = magics.length ? magics.map(s => `<div>${s.name} <span style="color:#88f">MP:${s.mp}</span></div>`).join('') : 'なし';

        // Tab 5: Skills
        const skills = p.skills.filter(s => !['魔法','回復','蘇生'].includes(s.type));
        let t5 = skills.length ? skills.map(s => `<div>${s.name} <span style="color:#88f">MP:${s.mp}</span></div>`).join('') : 'なし';

        let html = `
            <div class="tab-header">
                ${makeTab(1, '基本', true)} ${makeTab(2, '能力', false)} ${makeTab(3, '特殊', false)} ${makeTab(4, '魔法', false)} ${makeTab(5, '特技', false)}
            </div>
            ${makeContent(1, t1, true)} ${makeContent(2, t2, false)} ${makeContent(3, t3, false)} ${makeContent(4, t4, false)} ${makeContent(5, t5, false)}
        `;
        
        UI.openSubScreen("ステータス詳細", html);
    },

    switchStatusTab: (id) => {
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        // Nth child approach or simple loop match
        const btns = document.querySelectorAll('.tab-btn');
        btns[id-1].classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
    },

    showItems: () => {
        const list = Object.keys(Game.items).map(id => {
            const m = DB.ITEMS.find(i=>i.id==parseInt(id));
            return { ...m, count: Game.items[id] };
        }).filter(i=>i.count>0);
        
        UI.openSubScreen("道具一覧", list.map(i => `
            <div class="item-row" onclick="UI.useItemField(${i.id})">
                ${i.name} x${i.count} <br><small style="color:#aaa">${i.desc}</small>
            </div>
        `).join('') || '<div>道具を持っていません</div>');
    },

    useItemField: (id) => {
        const meta = DB.ITEMS.find(i=>i.id===id);
        if(!['HP回復','MP回復'].includes(meta.type)) { alert("ここでは使えません"); return; }
        
        let validTargets = Game.party.filter(p=>p!==null);
        UI.showList(validTargets, target => {
            if(Game.useItem(id)) {
                if(meta.type==='HP回復') target.hp = Math.min(target.maxHp, target.hp + meta.val);
                if(meta.type==='MP回復') target.mp = Math.min(target.maxMp, target.mp + meta.val);
                alert(`${target.name}は回復した！`);
                UI.showItems(); 
                return true;
            }
            return false;
        }, false);
    },

    showEquip: () => {
        const targets = Game.party.filter(p=>p!==null);
        UI.showList(targets, p => {
            UI.showList(CONST.PARTS.map(part => ({id:part, name:part})), partObj => {
                const part = partObj.name;
                const equips = Game.inventory.filter(e => e.type === part);
                
                const list = equips.map(e => {
                    const desc = e.opts.map(o => o.unit==='val' ? `${o.label}+${o.val}` : `${o.label}+${Math.floor(o.val*100)}%`).join(' ');
                    return {...e, desc: desc || '追加効果なし'};
                });
                
                list.unshift({id:'remove', name:'(外す)', type:part});

                UI.showList(list, eq => {
                    if(eq.id === 'remove') {
                        if(p.equips[part]) {
                            Game.inventory.push(p.equips[part]); 
                            p.equips[part] = null;
                        }
                    } else {
                        if(p.equips[part]) Game.inventory.push(p.equips[part]);
                        const idx = Game.inventory.indexOf(eq);
                        if(idx > -1) Game.inventory.splice(idx, 1);
                        p.equips[part] = eq;
                    }
                    alert("装備を変更しました");
                    return true;
                }, true);
                return false; 
            }, false);
            return false; 
        }, false);
    },

    showPartyForm: () => {
        const render = () => {
            let html = "";
            for(let i=0; i<4; i++) {
                const p = Game.party[i];
                html += `<div class="item-row" onclick="UI.swapMember(${i})">
                    [${i+1}] ${p ? `${p.name} (${p.job}) Lv.${p.level}` : '--- 空き ---'}
                </div>`;
            }
            UI.openSubScreen("パーティ編成 (タップで入替)", html);
        };
        render();
    },

    swapMember: (slotIdx) => {
        UI.showList(Game.allCharacters, (char) => {
            const currentIdx = Game.party.indexOf(char);
            if(currentIdx >= 0) {
                const temp = Game.party[slotIdx];
                Game.party[slotIdx] = char;
                Game.party[currentIdx] = temp;
            } else {
                Game.party[slotIdx] = char;
            }
            UI.showPartyForm(); 
            return true;
        }, false);
    },
    
    showCharList: () => {
        const html = Game.allCharacters.map(c => `
            <div class="item-row">
                <div>
                    <span class="rarity-${c.rarity}">[${c.rarity}]</span> ${c.name} (${c.job}) Lv.${c.level} <br>
                    <small>限界突破: ${c.limitBreak} (所持数: ${c.count})</small>
                </div>
                ${c.count > c.limitBreak + 1 ? `<button class="btn" onclick="UI.limitBreak(${c.id})">強化</button>` : '<span>-</span>'}
            </div>
        `).join('');
        UI.openSubScreen("仲間一覧", html);
    },

    limitBreak: (id) => {
        const char = Game.allCharacters.find(c => c.id === id);
        if(char && char.count > char.limitBreak + 1) {
            char.limitBreak++;
            alert(`${char.name}を強化しました！(ステータス+10%)`);
            UI.showCharList();
        }
    },

    showMonsterBook: () => {
        const html = DB.MONSTERS.map(m => {
            const known = Game.book.monsters.includes(m.id);
            return `<div class="item-row" style="color:${known?'#fff':'#555'}">
                ${known ? `<div><strong>${m.name}</strong> <small>HP:${m.hp} Drop:${m.dropRate}%</small></div>` : `<div>？？？</div>`}
            </div>`;
        }).join('');
        UI.openSubScreen("魔物図鑑", html);
    },

    showGacha: () => {
        UI.openSubScreen("ガチャ", `
            <div style="text-align:center; padding:20px;">
                <p>GEM: ${Game.gems}</p>
                <button class="btn" style="margin:10px auto; width:200px;" onclick="UI.pullGacha()">1回召喚 (300 GEM)</button>
                <div id="gacha-res" style="margin-top:20px;"></div>
            </div>
        `);
    },

    pullGacha: () => {
        if(Game.gems < 300) { alert("GEM不足"); return; }
        Game.gems -= 300;
        document.getElementById('menu-gem').innerText = Game.gems;
        const r = Math.random()*100;
        let rarity = r<50?'N':(r<80?'R':(r<94?'SR':(r<99?'UR':'EX')));
        const jobs = ['戦士','魔法使い','僧侶','武闘家','賢者','遊び人'];
        const job = jobs[rand(jobs.length)];
        const nameSeed = ['アレックス','ボブ','キャロル','デイブ','エレン'];
        const name = nameSeed[rand(nameSeed.length)] + rand(999);
        
        let char = Game.allCharacters.find(c => c.job===job && c.rarity===rarity);
        let isNew = false;
        if(char) char.count++;
        else {
            char = new Player(name, job, null, rarity);
            Game.allCharacters.push(char);
            isNew = true;
        }
        document.getElementById('gacha-res').innerHTML = `
            <div class="rarity-${rarity}" style="font-size:18px; margin-bottom:5px;">[${rarity}] ${char.name} (${char.job})</div>
            <div>${isNew ? "NEW!" : "重複入手(強化可能数+1)"}</div>
        `;
    },

    openSubScreen: (title, html) => {
        document.getElementById('sub-title').innerText = title;
        document.getElementById('sub-content').innerHTML = html;
        document.getElementById('sub-screen').style.display = 'flex';
    },

    showList: (items, onSelect, showDesc = false) => {
        const m = document.getElementById('list-modal');
        const c = document.getElementById('list-container');
        const d = document.getElementById('list-desc');
        c.innerHTML = '';
        d.innerText = showDesc ? 'タップで説明を表示 / もう一度タップで決定' : '';

        let selectedId = null;

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-row';
            const mpTxt = item.mp ? `<span style="color:#88f; font-size:11px;">MP:${item.mp}</span>` : '';
            const countTxt = item.count ? `x${item.count}` : '';
            div.innerHTML = `<div>${item.name} ${countTxt}</div> ${mpTxt}`;
            
            div.onclick = () => {
                if(showDesc && item.desc) {
                    if(selectedId === item.id) {
                        if(onSelect(item)) UI.closeList();
                    } else {
                        selectedId = item.id;
                        d.innerText = item.desc;
                        Array.from(c.children).forEach(ch => ch.classList.remove('selected'));
                        div.classList.add('selected');
                    }
                } else {
                    if(onSelect(item)) UI.closeList();
                }
            };
            c.appendChild(div);
        });
        m.style.display = 'flex';
    },
    closeList: () => { document.getElementById('list-modal').style.display = 'none'; },

    showDamage: (t, d, color='#fff') => {
        const el = document.createElement('div');
        el.className = 'damage-pop'; el.innerText = d; el.style.color = color;
        if(t.isDead !== undefined) { 
             el.style.left = (20+rand(60))+'%'; el.style.top = (20+rand(20))+'%';
        }
        document.getElementById('battle-scene').appendChild(el);
        setTimeout(()=>el.remove(), 800);
    },
    
    onOk: () => { if(!Battle.active) UI.openMenu(); },
    wait: (ms) => new Promise(r=>setTimeout(r,ms))
};

window.addEventListener('keydown', e => {
    if(e.key==='ArrowUp') Dungeon.move(0,-1);
    if(e.key==='ArrowDown') Dungeon.move(0,1);
    if(e.key==='ArrowLeft') Dungeon.move(-1,0);
    if(e.key==='ArrowRight') Dungeon.move(1,0);
    if(e.key==='Enter') UI.onOk();
});
['up','down','left','right'].forEach(d => 
    document.getElementById('btn-'+d).onclick = () => 
    Dungeon.move(d==='left'?-1:d==='right'?1:0, d==='up'?-1:d==='down'?1:0)
);

const resize = () => {
    const p = UI.canvas.parentElement;
    UI.canvas.width = p.clientWidth; UI.canvas.height = p.clientHeight;
    if(!Battle.active) UI.render();
};
window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>
