<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PRISMA ABYSS -Data Editor- v2.8</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22>
    <text y=%22.9em%22 font-size=%2290%22>âš”ï¸</text></svg>">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #1a1a1a; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 14px; }
        .editor-container { max-width: 1400px; margin: 0 auto; background: #2d2d2d; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å…±é€š */
        input, textarea, select { 
            background: #383838; color: #fff; border: 1px solid #555; padding: 4px 8px; border-radius: 4px; width: 100%; 
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: #ffd700; outline: none; }
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 2px; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #222; color: #ffd700; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #444; position: sticky; top: 0; z-index: 10; }
        td { border-bottom: 1px solid #444; padding: 8px; vertical-align: top; background: #2d2d2d; }
        tr:hover td { background: #333; }

        /* ã‚¿ãƒ– */
        .tab-btn { padding: 10px 20px; cursor: pointer; background: #222; border-bottom: 2px solid transparent; color: #888; font-weight: bold; transition: all 0.2s; }
        .tab-btn:hover { color: #ddd; background: #333; }
        .tab-btn.active { border-bottom: 2px solid #ffd700; color: #ffd700; background: #383838; }

        /* ãƒœã‚¿ãƒ³ */
        .btn { padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #005f5f; color: white; }
        .btn-secondary { background: #444; color: white; border: 1px solid #666; }
        .btn-danger { background: #8b0000; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-save { background: #d32f2f; color: white; padding: 8px 16px; display: flex; align-items: center; gap: 5px; }
        .btn-export { background: #5e35b1; color: white; }
        
        .save-area { display: flex; justify-content: flex-end; padding: 10px; background: #222; margin-bottom: 10px; border-radius: 4px; align-items: center; gap: 10px; }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ */
        .filter-btn { font-size: 12px; padding: 2px 8px; border-radius: 12px; background: #444; color: #aaa; border: 1px solid transparent; margin-right: 4px; }
        .filter-btn.active { background: #005f5f; color: #fff; border-color: #00aaaa; }

        /* ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã‚¨ãƒªã‚¢ */
        .export-box { width: 100%; height: 150px; background: #111; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #444; margin-top: 10px; white-space: pre; overflow-x: auto; }
    </style>
</head>
<body>

<div id="app" class="editor-container">
    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-yellow-400">PRISMA ABYSS Data Editor <span class="text-sm text-gray-500">v2.8</span></h1>
            <p class="text-xs text-gray-400">ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™</p>
        </div>
        <div class="text-right">
            <button @click="saveSystemFile" class="btn bg-gray-600 text-xs">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š(database.js)ã®ã¿ä¿å­˜</button>
        </div>
    </div>

    <div class="flex mb-4 border-b border-gray-700">
        <button v-for="tab in tabs" :key="tab.id" 
            class="tab-btn" :class="{active: currentTab===tab.id}" 
            @click="currentTab=tab.id">
            {{ tab.name }}
        </button>
    </div>

    <div v-if="currentTab==='skills'">
        <div class="bg-gray-800 p-3 rounded mb-4 border border-gray-600 flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center gap-2">
				<button @click="addSkill" class="btn btn-primary">+ æ–°è¦ã‚¹ã‚­ãƒ«ä½œæˆ</button>
				<button @click="sortSkills" class="btn btn-secondary">IDé †ã‚½ãƒ¼ãƒˆ</button>
			</div>
			<div class="flex gap-2">
				<button @click="downloadCSV('skills')" class="btn bg-green-700 text-white text-xs">CSVå‡ºåŠ›</button>
				<button @click="triggerCSVImport('skills')" class="btn bg-green-900 text-white text-xs border border-green-700">CSVå–è¾¼</button>
				
				<button @click="toggleExport('skills')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
			</div>
            <div class="flex items-center gap-1 overflow-x-auto max-w-[600px]">
                <span class="text-xs text-gray-400 mr-1">ãƒ•ã‚£ãƒ«ã‚¿:</span>
                <button class="filter-btn" :class="{active: skillFilter === 'ALL'}" @click="skillFilter = 'ALL'">ALL</button>
                <button v-for="t in skillTypes" :key="t" class="filter-btn" :class="{active: skillFilter === t}" @click="skillFilter = t">{{ t }}</button>
            </div>
            <div><button @click="toggleExport('skills')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button></div>
        </div>

        <div v-if="showExport.skills" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (Ctrl+A ã§å…¨é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼)</label>
                <button @click="showExport.skills = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.skills"></textarea>
        </div>

        <div class="save-area">
            <button @click="savePartial('skills')" class="btn btn-save">ğŸ’¾ ã‚¹ã‚­ãƒ«ãƒ‡ãƒ¼ã‚¿ (skills.js) ã‚’ä¿å­˜</button>
        </div>

        <div class="overflow-x-auto h-[70vh]">
		
		<table class="w-full text-sm">
			<thead>
				<tr>
					<th style="width:60px" class="text-center">ID</th>
					<th style="width:320px">åŸºæœ¬è¨­å®š</th>
					<th>è©³ç´°ãƒ»è¿½åŠ åŠ¹æœ</th>
					<th style="width:50px" class="text-center">å‰Šé™¤</th>
				</tr>
			</thead>
			<tbody>
				<tr v-for="(s, index) in filteredSkills" :key="s._uid">
					<td class="align-top">
						<input type="number" v-model.number="s.id" class="text-center font-mono text-yellow-200 bg-gray-800 font-bold text-lg h-10">
					</td>

					<td class="align-top">
						<div class="flex flex-col gap-2">
							<div>
								<input type="text" v-model="s.name" class="font-bold mb-1" placeholder="ã‚¹ã‚­ãƒ«å">
								<textarea v-model="s.desc" class="text-xs h-12 resize-none" placeholder="ã‚¹ã‚­ãƒ«ã®èª¬æ˜æ–‡"></textarea>
							</div>

							<div class="bg-gray-800 p-2 rounded border border-gray-700 grid grid-cols-3 gap-1">
								<div>
									<label class="text-[10px]">ã‚¿ã‚¤ãƒ—</label>
									<select v-model="s.type" class="text-xs h-6 p-0 px-1">
										<option v-for="t in skillTypes" :value="t">{{t}}</option>
									</select>
								</div>
								<div>
									<label class="text-[10px]">å±æ€§</label>
									<select v-model="s.elm" class="text-xs h-6 p-0 px-1">
										<option :value="null">-</option>
										<option v-for="e in elements" :value="e">{{e}}</option>
									</select>
								</div>
								<div>
									<label class="text-[10px]">å¯¾è±¡</label>
									<select v-model="s.target" class="text-xs h-6 p-0 px-1">
										<option v-for="t in skillTargets" :value="t">{{t}}</option>
									</select>
								</div>
							</div>

							<div class="bg-gray-800 p-2 rounded border border-gray-700">
								<div class="grid grid-cols-2 gap-2 mb-2">
									<div><label class="text-[10px]">åŸºæœ¬å¨åŠ›</label><input type="number" v-model.number="s.base" class="text-xs h-6 text-right"></div>
									<div><label class="text-[10px]">å€ç‡</label><input type="number" v-model.number="s.rate" step="0.1" class="text-xs h-6 text-right"></div>
								</div>
								<div class="grid grid-cols-2 gap-2">
									<div><label class="text-[10px] text-blue-300">æ¶ˆè²»MP</label><input type="number" v-model.number="s.mp" class="text-xs h-6 text-right text-blue-200"></div>
									<div><label class="text-[10px]">æ”»æ’ƒå›æ•°</label><input type="number" v-model.number="s.count" class="text-xs h-6 text-right"></div>
								</div>
							</div>
						</div>
					</td>

					<td class="align-top">
						<div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
							<div class="space-y-2">
								<div class="grid grid-cols-4 gap-1 text-xs">
									<div><label>å„ªå…ˆåº¦</label><input type="number" v-model.number="s.priority" placeholder="0" class="h-6 text-center"></div>
									<div><label>å‘½ä¸­%</label><input type="number" v-model.number="s.SuccessRate" placeholder="100" class="h-6 text-center"></div>
									<div><label>å‰²åˆ</label><input type="number" v-model.number="s.PercentDamage" placeholder="0~1" step="0.1" class="h-6 text-center"></div>
									<div><label class="text-purple-300">ã‚¿ãƒ¼ãƒ³</label><input type="number" v-model.number="s.turn" placeholder="0" class="h-6 text-center"></div>
								</div>
								
								<div class="grid grid-cols-3 gap-y-1 gap-x-1 text-[10px] bg-gray-900 p-1.5 rounded border border-gray-700">
									<label class="flex items-center cursor-pointer hover:text-white"><input type="checkbox" v-model="s.drain" class="w-3 h-3 mr-1">å¸å</label>
									<label class="flex items-center cursor-pointer hover:text-white"><input type="checkbox" v-model="s.fix" class="w-3 h-3 mr-1">å›ºå®šãƒ€ãƒ¡</label>
									<label class="flex items-center cursor-pointer hover:text-white text-red-300" title="é˜²å¾¡ç„¡è¦–"><input type="checkbox" v-model="s.IgnoreDefense" class="w-3 h-3 mr-1">é˜²å¾¡ç„¡è¦–</label>
									
									<label class="flex items-center cursor-pointer hover:text-white text-green-300" title="å‘³æ–¹ã®çŠ¶æ…‹ç•°å¸¸ã‚’å›å¾©"><input type="checkbox" v-model="s.CureAilments" class="w-3 h-3 mr-1">ç•°å¸¸æ¶ˆå»</label>
									<label class="flex items-center cursor-pointer hover:text-white text-blue-300" title="å‘³æ–¹ã®ãƒ‡ãƒãƒ•ã‚’è§£é™¤"><input type="checkbox" v-model="s.debuff_reset" class="w-3 h-3 mr-1">ãƒ‡ãƒãƒ•æ¶ˆå»</label>
									<label class="flex items-center cursor-pointer hover:text-white text-orange-300" title="æ•µã®ãƒãƒ•ã‚’è§£é™¤"><input type="checkbox" v-model="s.buff_reset" class="w-3 h-3 mr-1">ãƒãƒ•æ¶ˆå»</label>
								</div>
								
								<div class="bg-gray-800 p-2 rounded">
									<label class="text-[10px] font-bold text-yellow-500 mb-1 block">çŠ¶æ…‹ç•°å¸¸ä»˜ä¸</label>
									<div class="grid grid-cols-2 gap-y-1 gap-x-2">
										<label v-for="(label, key) in ailmentLabels" :key="key" class="flex items-center cursor-pointer text-[10px] hover:text-white transition-colors">
											<input type="checkbox" v-model="s[key]" class="w-3 h-3 mr-1 accent-red-500"> {{label}}
										</label>
									</div>
								</div>
							</div>

							<div class="space-y-2">
								<div class="bg-gray-800 p-2 rounded border border-gray-600">
									<label class="text-[10px] font-bold text-green-400 mb-1 block">ãƒãƒ• (å¼·åŒ–)</label>
									<div class="grid grid-cols-4 gap-1 mb-1">
										<div v-for="k in ['atk','def','spd','mag']" :key="k" class="flex items-center">
											<span class="text-[9px] w-4 text-gray-400">{{k.toUpperCase().substr(0,1)}}</span>
											<input type="number" step="0.1" placeholder="1.0" 
												   :value="s.buff && s.buff[k] ? s.buff[k] : ''" 
												   @input="updateBuff(s, k, $event.target.value)"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center px-0">
										</div>
									</div>
									<div class="grid grid-cols-2 gap-1 mb-1">
										<div class="flex items-center">
											<span class="text-[9px] w-8 text-gray-400">HPãƒªã‚¸ã‚§</span>
											<input type="number" step="0.01" placeholder="0.05"
												   :value="s.HPRegen || ''" 
												   @input="s.HPRegen = $event.target.value ? Number($event.target.value) : undefined"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center px-0">
										</div>
										<div class="flex items-center">
											<span class="text-[9px] w-8 text-gray-400">MPãƒªã‚¸ã‚§</span>
											<input type="number" step="0.01" placeholder="0.05"
												   :value="s.MPRegen || ''" 
												   @input="s.MPRegen = $event.target.value ? Number($event.target.value) : undefined"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center px-0">
										</div>
									</div>
									
									<div class="grid grid-cols-1 gap-1">
										<div class="flex items-center">
											<span class="text-[9px] w-12 text-blue-300">å…¨å±æ€§è€æ€§</span>
											<input type="number" placeholder="%" 
												   :value="s.buff && s.buff['elmResUp'] ? s.buff['elmResUp'] : ''" 
												   @input="updateBuff(s, 'elmResUp', $event.target.value)"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center text-blue-200">
										</div>
										
										<div class="mt-1">
											<details class="text-[10px]">
												<summary class="cursor-pointer text-gray-500 hover:text-white">çŠ¶æ…‹ç•°å¸¸è€æ€§ãƒãƒ•...</summary>
												<div class="grid grid-cols-2 gap-1 mt-1 bg-gray-900 p-1 rounded">
													<div v-for="(label, key) in resistLabels" :key="key" class="flex items-center justify-between px-1">
														<span class="text-[9px] text-gray-400">{{label}}</span>
														<input type="number" placeholder="%" 
															   :value="s.buff && s.buff['resists_'+key] ? s.buff['resists_'+key] : ''"
															   @input="updateBuff(s, 'resists_'+key, $event.target.value)"
															   class="w-8 text-[10px] h-4 bg-gray-800 border border-gray-600 text-center px-0">
													</div>
												</div>
											</details>
										</div>
									</div>
								</div>

								<div class="bg-gray-800 p-2 rounded border border-gray-600">
									<label class="text-[10px] font-bold text-red-400 mb-1 block">ãƒ‡ãƒãƒ• (å¼±ä½“)</label>
									<div class="grid grid-cols-4 gap-1 mb-1">
										<div v-for="k in ['atk','def','spd','mag']" :key="k" class="flex items-center">
											<span class="text-[9px] w-4 text-gray-400">{{k.toUpperCase().substr(0,1)}}</span>
											<input type="number" step="0.1" placeholder="1.0" 
												   :value="s.debuff && s.debuff[k] ? s.debuff[k] : ''" 
												   @input="updateDebuff(s, k, $event.target.value)"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center text-red-200 px-0">
										</div>
									</div>
									<div class="grid grid-cols-1 gap-1">
										<div class="flex items-center">
											<span class="text-[9px] w-12 text-blue-300">å…¨å±æ€§è€æ€§</span>
											<input type="number" placeholder="%" 
												   :value="s.debuff && s.debuff['elmResDown'] ? s.debuff['elmResDown'] : ''" 
												   @input="updateDebuff(s, 'elmResDown', $event.target.value)"
												   class="text-[10px] h-5 bg-gray-900 border border-gray-700 text-center text-red-200">
										</div>

										<div class="mt-1">
											<details class="text-[10px]">
												<summary class="cursor-pointer text-gray-500 hover:text-white">çŠ¶æ…‹ç•°å¸¸è€æ€§ãƒ€ã‚¦ãƒ³...</summary>
												<div class="grid grid-cols-2 gap-1 mt-1 bg-gray-900 p-1 rounded">
													<div v-for="(label, key) in resistLabels" :key="key" class="flex items-center justify-between px-1">
														<span class="text-[9px] text-gray-400">{{label}}</span>
														<input type="number" placeholder="%" 
															   :value="s.debuff && s.debuff['resists_'+key] ? s.debuff['resists_'+key] : ''"
															   @input="updateDebuff(s, 'resists_'+key, $event.target.value)"
															   class="w-8 text-[10px] h-4 bg-gray-800 border border-gray-600 text-center px-0">
													</div>
												</div>
											</details>
										</div>
									</div>
								</div>
							</div>
						</div>
					</td>
					
					<td class="text-center align-middle">
						<button @click="removeList(db.SKILLS, db.SKILLS.indexOf(s))" class="btn btn-danger text-xs">Ã—</button>
					</td>
				</tr>
			</tbody>
		</table>

        </div>
    </div>

    <div v-if="currentTab === 'monsters'">
        <div class="bg-gray-800 p-2 rounded mb-2 border border-gray-600 flex justify-end gap-2">
            <button @click="downloadCSV('monsters')" class="btn bg-green-700 text-white text-xs">CSVå‡ºåŠ›</button>
            <button @click="triggerCSVImport('monsters')" class="btn bg-green-900 text-white text-xs border border-green-700">CSVå–è¾¼</button>
            <button @click="toggleExport('monsters')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
        </div>

        <div v-if="showExport.monsters" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                <button @click="showExport.monsters = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.monsters"></textarea>
        </div>

        <div class="save-area">
            <button @click="savePartial('monsters')" class="btn btn-save">ğŸ’¾ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ (monsters.js) ã‚’ä¿å­˜</button>
        </div>

        <div class="grid grid-cols-12 gap-4 h-[75vh]">
            <div class="col-span-3 overflow-y-auto pr-2 border-r border-gray-600 flex flex-col">
                <div v-for="m in db.MONSTERS" :key="m._uid" 
                     @click="selectMonster(m)"
                     :class="['p-3 mb-2 cursor-pointer rounded border transition-all duration-200', selectedMonster && selectedMonster.id === m.id ? 'bg-blue-900 border-blue-400 shadow-inner' : 'bg-gray-700 border-gray-600 hover:bg-gray-600']">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-mono text-[10px] text-gray-400">ID: {{m.id}}</span>
                        <span v-if="m.isRare" class="text-[10px] bg-yellow-500 text-black px-1.5 py-0.5 rounded font-bold">RARE</span>
                    </div>
                    <div class="font-bold text-white truncate">{{m.name}}</div>
                    <div class="text-[10px] text-gray-400 mt-1">Rank: {{m.rank}} / minF: {{m.minF}}</div>
                </div>
                <button @click="addMonster" class="btn btn-primary w-full mt-2 font-bold shadow-lg">+ æ–°è¦è¿½åŠ </button>
            </div>

            <div class="col-span-9 overflow-y-auto pl-2" v-if="selectedMonster">
                <div class="grid grid-cols-12 gap-6">
                    
                    <div class="col-span-4 space-y-4">
                        <h3 class="text-yellow-400 border-b border-gray-600 pb-1 font-bold">åŸºæœ¬è¨­å®š</h3>
                        <div><label>ID</label><input type="number" v-model.number="selectedMonster.id"></div>
                        <div><label>åå‰</label><input type="text" v-model="selectedMonster.name" class="font-bold text-lg"></div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div><label>å‡ºç¾Rank</label><input type="number" v-model.number="selectedMonster.rank"></div>
                            <div><label>é–‹å§‹éšå±¤(minF)</label><input type="number" v-model.number="selectedMonster.minF"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div><label>HP</label><input type="number" v-model.number="selectedMonster.hp" class="text-green-300"></div>
                            <div><label>MP</label><input type="number" v-model.number="selectedMonster.mp" class="text-blue-300"></div>
                        </div>

                        <div class="flex items-center p-2 bg-gray-900 border border-gray-700 rounded shadow-inner">
                            <input type="checkbox" id="m-rare" v-model="selectedMonster.isRare" class="w-5 h-5 accent-yellow-500">
                            <label for="m-rare" class="ml-2 text-yellow-400 font-bold text-sm cursor-pointer select-none">ãƒ¬ã‚¢ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åˆ¤å®š</label>
                        </div>

                        <div class="p-2 bg-black rounded text-center border border-gray-600 shadow-md">
                            <img :src="selectedMonster.img || dummyImg" class="h-32 mx-auto object-contain mb-2">
                            <label class="btn btn-primary text-xs cursor-pointer block">
                                ç”»åƒã‚’é¸æŠ (Base64)
                                <input type="file" accept="image/*" class="hidden" @change="e => handleImageUpload(e, selectedMonster)">
                            </label>
                        </div>

                        <div class="pt-4">
                            <button @click="removeList(db.MONSTERS, db.MONSTERS.indexOf(selectedMonster)); selectedMonster=null" 
                                    class="btn btn-danger w-full text-xs py-2 shadow-lg">ã“ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å‰Šé™¤</button>
                        </div>
                    </div>

                    <div class="col-span-8 space-y-4">
                        <h3 class="text-yellow-400 border-b border-gray-600 pb-1 font-bold">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & å ±é…¬ãƒ»è€æ€§</h3>
                        
                        <div class="grid grid-cols-6 gap-2">
                            <div><label>æ”»æ’ƒåŠ›</label><input type="number" v-model.number="selectedMonster.atk"></div>
                            <div><label>å®ˆå‚™åŠ›</label><input type="number" v-model.number="selectedMonster.def"></div>
                            <div><label>ç´ æ—©ã•</label><input type="number" v-model.number="selectedMonster.spd"></div>
                            <div><label>é­”åŠ›</label><input type="number" v-model.number="selectedMonster.mag"></div>
                            <div class="col-span-1 bg-blue-900 bg-opacity-20"><label class="text-blue-300">çµŒé¨“å€¤</label><input type="number" v-model.number="selectedMonster.exp" class="border-blue-700"></div>
                            <div class="col-span-1 bg-yellow-900 bg-opacity-20"><label class="text-yellow-300">GOLD</label><input type="number" v-model.number="selectedMonster.gold" class="border-yellow-700"></div>
                        </div>

                        <div class="bg-gray-800 p-3 rounded border border-gray-600 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-bold text-green-400">è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š</label>
                                <div class="text-xs text-gray-400">1ã‚¿ãƒ¼ãƒ³ã®è¡Œå‹•å›æ•°: <input type="number" v-model.number="selectedMonster.actCount" class="w-10 text-center bg-gray-900 border-gray-700"></div>
                            </div>
                            <div class="max-h-40 overflow-y-auto pr-1 space-y-1">
                                <div v-for="(act, idx) in selectedMonster.acts" :key="idx" class="flex gap-2 items-center bg-gray-900 p-1 rounded border border-gray-700">
                                    <select v-model.number="act.condition" class="w-24 text-xs bg-gray-700 border-none">
                                        <option :value="0">å¸¸æ™‚</option>
                                        <option :value="1">HPâ‰§50%</option>
                                        <option :value="2">HPâ‰¦50%</option>
                                        <option :value="3">çŠ¶æ…‹ç•°å¸¸ä¸­</option>
                                    </select>
                                    <select v-model="act.id" class="flex-1 text-xs bg-gray-800 border-none">
                                        <option v-for="s in db.SKILLS" :value="s.id">{{ s.name }} (ID:{{s.id}})</option>
                                    </select>
                                    <div class="flex items-center w-16">
                                        <input type="number" v-model.number="act.rate" class="w-full text-right text-xs bg-gray-700 border-none">
                                        <span class="text-xs text-gray-500 ml-1">%</span>
                                    </div>
                                    <button @click="selectedMonster.acts.splice(idx, 1)" class="text-red-500 font-bold px-2 hover:text-red-300">Ã—</button>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button @click="addMonsterAct" class="btn btn-success text-xs flex-1">+ è¡Œå‹•è¿½åŠ </button>
                                <button @click="recalcMonsterActs" class="btn btn-secondary text-xs flex-1">é‡ã¿ã‚’å‡ç­‰åŒ–</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-800 p-3 rounded border border-gray-600 shadow-md">
                                <label class="text-xs font-bold text-red-400 mb-2 block uppercase tracking-widest">å±æ€§è€æ€§ (%)</label>
                                <div class="grid grid-cols-2 gap-x-3 gap-y-1">
                                    <div v-for="el in elements" :key="el" class="flex items-center justify-between">
                                        <span class="text-[10px] text-gray-500">{{el}}</span>
                                        <input type="number" v-model.number="selectedMonster.elmRes[el]" class="w-12 text-right text-[10px] h-5 py-0">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-3 rounded border border-gray-600 shadow-md">
                                <label class="text-xs font-bold text-purple-400 mb-2 block uppercase tracking-widest">çŠ¶æ…‹ç•°å¸¸è€æ€§ (%)</label>
                                <div class="space-y-1">
                                    <div v-for="(label, key) in resistLabels" :key="key" class="flex items-center justify-between">
                                        <span class="text-[10px] text-gray-500">{{label}}</span>
                                        <input type="number" v-model.number="selectedMonster.resists[key]" class="w-16 text-right text-[10px] h-5 py-0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="col-span-9 flex items-center justify-center text-gray-600 border-2 border-dashed border-gray-800 rounded-lg">
                <div class="text-center">
                    <div class="text-4xl mb-2">ğŸ‘¾</div>
                    <p>å·¦å´ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab==='characters'">
				<div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-yellow-500">ä»²é–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š</h2>
                    <div class="flex gap-2">
                        <button @click="downloadCharacterCSV" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1">
                            <span>ğŸ“¥</span> CSVå‡ºåŠ›
                        </button>
                        <button @click="triggerCSVImport('characters')" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1">
                            <span>ğŸ“¤</span> CSVå–è¾¼
                        </button>
                        <button @click="addCharacter" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold px-4 py-1 rounded text-xs">
                            + æ–°è¦ã‚­ãƒ£ãƒ©è¿½åŠ 
                        </button>
                    </div>
                </div>
        <div class="bg-gray-800 p-2 rounded mb-2 border border-gray-600 flex justify-end">
            <button @click="toggleExport('characters')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
        </div>
        <div v-if="showExport.characters" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                <button @click="showExport.characters = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.characters"></textarea>
        </div>

        <div class="save-area">
            <button @click="savePartial('characters')" class="btn btn-save">ğŸ’¾ ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ (characters.js) ã‚’ä¿å­˜</button>
        </div>
        <table class="w-full">
            <thead>
                <tr>
                    <th style="width:60px">ç”»åƒ</th>
                    <th style="width:60px">ID</th>
                    <th style="width:200px">åå‰/è·æ¥­/ãƒ¬ã‚¢</th>
                    <th>åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (HP/MP/æ”»/é˜²/é€Ÿ/é­”)</th>
                    <th style="width:220px">æˆé•·/LBã‚¹ã‚­ãƒ«</th>
                    <th style="width:50px">å‰Šé™¤</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(c, index) in db.CHARACTERS" :key="c._uid">
                    <td class="text-center align-middle">
                        <label class="cursor-pointer block">
                            <img :src="c.img || dummyImg" class="w-10 h-10 object-cover rounded bg-black mx-auto border border-gray-600">
                            <input type="file" accept="image/*" class="hidden" @change="e => handleImageUpload(e, c)">
                        </label>
                    </td>
                    <td class="align-middle"><input type="number" v-model.number="c.id" class="text-center"></td>
                    <td>
                        <div class="flex gap-1 mb-1"><input type="text" v-model="c.name" placeholder="åå‰" class="font-bold"></div>
                        <div class="flex gap-1">
                            <select v-model="c.job" class="text-xs bg-gray-800 border border-gray-500 w-full" title="è·æ¥­ã‚’é¸æŠ">
                                <option v-for="(skills, jobName) in jobSkills" :key="jobName" :value="jobName">
                                    {{ jobName }}
                                </option>
                            </select>
                            
                            <select v-model="c.rarity" class="w-20 text-xs bg-gray-800 border border-gray-500">
                                <option>N</option><option>R</option><option>SR</option><option>SSR</option><option>UR</option><option>EX</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="grid grid-cols-3 gap-1">
                            <input type="number" v-model.number="c.hp" placeholder="HP" title="HP" class="text-green-200">
                            <input type="number" v-model.number="c.mp" placeholder="MP" title="MP" class="text-blue-200">
                            <input type="number" v-model.number="c.atk" placeholder="æ”»" title="æ”»æ’ƒ">
                            <input type="number" v-model.number="c.def" placeholder="é˜²" title="é˜²å¾¡">
                            <input type="number" v-model.number="c.spd" placeholder="é€Ÿ" title="ç´ æ—©ã•">
                            <input type="number" v-model.number="c.mag" placeholder="é­”" title="é­”åŠ›">
                        </div>
                    </td>
                    <td>
                        <div class="grid grid-cols-2 gap-1 mb-1">
                            <div class="text-xs">SPåˆæœŸå€¤ <input type="number" v-model.number="c.sp" class="w-12 text-center"></div>
                            <div class="text-xs">LvåˆæœŸå€¤ <input type="number" v-model.number="c.level" class="w-12 text-center"></div>
                        </div>
                        <div class="bg-gray-800 p-1 rounded border border-gray-600">
                            <div class="flex items-center mb-1">
                                <span class="text-xs w-8 text-yellow-500">LB50</span>
                                <select v-model.number="c.lbSkills[50]" class="text-xs h-6 bg-gray-900 border-none w-full">
                                    <option :value="undefined">-</option>
                                    <option v-for="s in db.SKILLS" :value="s.id">{{s.name}}</option>
                                </select>
                            </div>
                            <div class="flex items-center">
                                <span class="text-xs w-8 text-yellow-500">LB99</span>
                                <select v-model.number="c.lbSkills[99]" class="text-xs h-6 bg-gray-900 border-none w-full">
                                    <option :value="undefined">-</option>
                                    <option v-for="s in db.SKILLS" :value="s.id">{{s.name}}</option>
                                </select>
                            </div>
                        </div>
						
						<div class="mt-4 bg-gray-900 p-3 rounded border border-gray-700">
                        <h3 class="text-sm font-bold text-yellow-500 mb-2 border-b border-gray-700 pb-1">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ)</h3>
                        <div v-if="!c.archives" class="py-2">
                            <button @click="c.archives = {base:'', lv50:'', lb50:'', lv100:'', lb99:''}" 
                                    class="text-[10px] bg-blue-600 px-2 py-1 rounded hover:bg-blue-700">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’åˆæœŸåŒ–</button>
                        </div>
                        <div v-else class="grid grid-cols-1 gap-3">
                            <div v-for="(label, key) in {base:'åˆæœŸ', lv50:'ãƒ¬ãƒ™ãƒ«50', lb50:'é™ç•Œçªç ´+50', lv100:'ãƒ¬ãƒ™ãƒ«100', lb99:'é™ç•Œçªç ´+99'}" :key="key">
                                <label class="block text-[10px] text-gray-500 mb-1">{{ label }} ({{ key }})</label>
                                <textarea v-model="c.archives[key]" 
                                          class="w-full bg-gray-800 text-xs p-2 rounded border border-gray-600 h-16 focus:border-yellow-500 outline-none" 
                                          placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                            </div>
                        </div>
                    </div>
						
                    </td>
                    <td class="text-center align-middle">
                        <button @click="removeList(db.CHARACTERS, index)" class="btn btn-danger text-xs">Ã—</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="mt-4"><button @click="addCharacter" class="btn btn-primary w-full">+ ä»²é–“ã‚’è¿½åŠ </button></div>
    </div>

    <div v-if="currentTab==='items'">
        <div class="bg-gray-800 p-2 rounded mb-2 border border-gray-600 flex justify-end">
            <button @click="toggleExport('items')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
        </div>
        <div v-if="showExport.items" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                <button @click="showExport.items = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.items"></textarea>
        </div>

        <div class="save-area">
            <button @click="savePartial('items')" class="btn btn-save">ğŸ’¾ ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ (items.js) ã‚’ä¿å­˜</button>
        </div>
        <table class="w-full">
            <thead>
                <tr>
                    <th style="width:80px">ID / Rank</th>
                    <th style="width:150px">åå‰</th>
                    <th style="width:120px">ã‚¿ã‚¤ãƒ—</th>
                    <th>åŠ¹æœå€¤/ä¾¡æ ¼</th>
                    <th>èª¬æ˜/å¯¾è±¡/ç‰¹æ®ŠåŠ¹æœ</th>
                    <th style="width:50px">å‰Šé™¤</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(item, index) in db.ITEMS" :key="item._uid">
                    <td class="align-middle">
                        <div class="flex flex-col gap-1">
                            <input type="number" v-model.number="item.id" class="text-center text-xs" placeholder="ID" title="ID">
                            <div class="flex items-center">
                                <span class="text-[10px] text-gray-500 w-4 text-center">R</span>
                                <input type="number" v-model.number="item.rank" class="text-center text-yellow-200 bg-gray-900 font-bold text-xs" placeholder="Rank" title="Rank">
                            </div>
                        </div>
                    </td>
                    <td><input type="text" v-model="item.name" class="font-bold"></td>
                    <td>
                        <select v-model="item.type">
                            <option>HPå›å¾©</option><option>MPå›å¾©</option><option>è˜‡ç”Ÿ</option><option>çŠ¶æ…‹ç•°å¸¸å›å¾©</option><option>è²´é‡å“</option>
                        </select>
                    </td>
                    <td>
                        <div class="flex gap-1 mb-1"><label>åŠ¹æœ</label><input type="number" v-model.number="item.val"></div>
                        <div class="flex gap-1"><label>ä¾¡æ ¼</label><input type="number" v-model.number="item.price" class="text-yellow-200"></div>
                    </td>
                    <td>
                        <div class="flex gap-1 mb-1">
                            <input type="text" v-model="item.desc" placeholder="èª¬æ˜" class="flex-1 text-xs">
                            <select v-model="item.target" class="w-20 text-xs"><option>å˜ä½“</option><option>å…¨ä½“</option><option>ãªã—</option></select>
                        </div>
                        <div class="flex gap-1 text-xs">
                            <input type="text" :value="item.cures ? item.cures.join(',') : ''" @input="item.cures=$event.target.value.split(',')" placeholder="æ²»ç™‚(Poison,Shock...)">
                        </div>
                    </td>
                    <td class="text-center align-middle">
                        <button @click="removeList(db.ITEMS, index)" class="btn btn-danger text-xs">Ã—</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="mt-4"><button @click="addItem" class="btn btn-primary w-full">+ ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ </button></div>
    </div>

    <div v-if="currentTab==='jobs'">
        <div class="save-area">
            <button @click="saveJobFile" class="btn btn-save">ğŸ’¾ è·æ¥­ãƒ‡ãƒ¼ã‚¿ (job_data.js) ã‚’ä¿å­˜</button>
        </div>
        
        <div class="bg-gray-800 p-2 rounded mb-4 border border-gray-600 flex justify-between items-start">
            <div class="flex flex-wrap gap-2 flex-1 mr-4">
                <button v-for="(skills, jobName) in jobSkills" :key="jobName"
                    class="btn mb-1" :class="currentJob===jobName ? 'btn-primary' : 'bg-gray-700'"
                    @click="currentJob=jobName">
                    {{ jobName }}
                </button>
                <button @click="addNewJob" class="btn bg-gray-600 border border-dashed border-gray-400 text-gray-300 mb-1">+ æ–°è¦è·</button>
            </div>
            <div>
                <button @click="toggleExport('jobs')" class="btn btn-export text-xs whitespace-nowrap">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
            </div>
        </div>

        <div v-if="showExport.jobs" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                <button @click="showExport.jobs = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.jobs"></textarea>
        </div>

        <div v-if="currentJob" class="bg-gray-800 p-4 rounded border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-yellow-400">{{ currentJob }} ã®ç¿’å¾—ã‚¹ã‚­ãƒ«</h3>
                <button @click="removeJob(currentJob)" class="btn btn-danger text-xs">ã“ã®è·æ¥­ã‚’å‰Šé™¤</button>
            </div>
            
            <div class="grid grid-cols-5 gap-2 max-h-96 overflow-y-auto">
                <div v-for="lv in 100" :key="lv" class="flex items-center bg-gray-900 p-1 rounded border border-gray-700">
                    <span class="text-xs text-gray-500 w-6 text-right mr-1">{{ lv }}</span>
                    <select :value="jobSkills[currentJob][lv] || ''" 
                            @change="updateJobSkill(currentJob, lv, $event.target.value)"
                            class="text-xs p-1 h-6 w-full bg-gray-800 border-none outline-none"
                            :class="{'text-yellow-200 font-bold': jobSkills[currentJob][lv]}">
                        <option value="">-</option>
                        <option v-for="s in db.SKILLS" :value="s.id">{{ s.name }} ({{s.id}})</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

<div v-if="currentTab==='equips'">
        <div class="bg-gray-800 p-3 rounded mb-4 border border-gray-600 space-y-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button @click="addEquipMaster" class="btn btn-primary">+ æ–°è¦è£…å‚™è¿½åŠ </button>
                    <button @click="toggleExport('equips')" class="btn btn-export text-xs">DBç”¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
                </div>
                <button @click="savePartial('equips')" class="btn btn-save">ğŸ’¾ è£…å‚™ãƒ‡ãƒ¼ã‚¿ (equips.js) ã‚’ä¿å­˜</button>
            </div>
            
            <div class="flex items-center gap-1 overflow-x-auto pb-1 border-t border-gray-700 pt-2">
                <span class="text-xs text-gray-400 mr-1 shrink-0">ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿:</span>
                <button class="filter-btn" :class="{active: equipFilter === 'ALL'}" @click="equipFilter = 'ALL'">ALL</button>
                <button v-for="b in allBaseNames" :key="b" 
                        class="filter-btn" :class="{active: equipFilter === b}" 
                        @click="equipFilter = b">{{ b }}</button>
            </div>
        </div>

        <div v-if="showExport.equips" class="mb-4">
            <div class="flex justify-between items-end mb-1">
                <label class="text-xs text-purple-300">â–¼ DBç›´æ›¸ãç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</label>
                <button @click="showExport.equips = false" class="text-xs text-gray-500 hover:text-white">é–‰ã˜ã‚‹</button>
            </div>
            <textarea class="export-box" readonly v-model="exportText.equips"></textarea>
        </div>

        <div class="overflow-x-auto h-[70vh] border border-gray-700 rounded">
            <table class="w-full text-sm">
                <thead class="sticky top-0 z-20">
                    <tr>
                        <th style="width:60px" class="text-center text-[11px]">Rank</th>
                        <th style="width:150px" class="text-[11px]">åŸºæœ¬è¨­å®š</th>
                        <th style="width:140px" class="text-[11px]">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th style="width:280px" class="text-[11px]">å±æ€§ãƒ»ç‰¹æ®ŠåŠ¹æœ</th>
                        <th style="width:180px" class="text-[11px]">ã‚ªãƒ—ã‚·ãƒ§ãƒ³å€™è£œ</th>
                        <th style="width:40px" class="text-center text-[11px]">æ¶ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(e, index) in filteredEquips" :key="e._uid">
                        <td class="align-top">
                            <input type="number" v-model.number="e.rank" class="text-center font-bold text-yellow-200 h-8 text-[11px]">
                        </td>
                        <td class="align-top space-y-1">
                            <input type="text" v-model="e.name" class="font-bold border-blue-900 h-7 text-[12px]" placeholder="è£…å‚™å">
                            <div class="grid grid-cols-2 gap-1">
                                <select v-model="e.type" @change="onEquipTypeChange(e)" class="text-[10px] h-6 p-0 px-1 bg-gray-800">
                                    <option v-for="(bases, type) in equipTypeMap" :key="type" :value="type">{{type}}</option>
                                </select>
                                <select v-model="e.baseName" class="text-[10px] h-6 p-0 px-1 bg-gray-700">
                                    <option v-for="b in equipTypeMap[e.type]" :key="b" :value="b">{{b}}</option>
                                </select>
                            </div>
                        </td>
                        <td class="align-top">
                            <div class="grid grid-cols-2 gap-x-2 gap-y-1 bg-gray-900 p-1.5 rounded border border-gray-700">
                                <div v-for="stat in mainStatKeys" :key="stat.k" class="flex items-center justify-between gap-1">
                                    <span class="text-[9px] text-gray-500 leading-tight shrink-0">{{stat.n}}</span>
                                    <input type="number" v-model.number="e.data[stat.k]" 
                                           class="text-[10px] h-5 w-12 p-0 text-right bg-gray-800 border-none rounded">
                                </div>
                            </div>
                        </td>
                        <td class="align-top space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="space-y-1">
                                    <div class="bg-gray-800 p-1 rounded border border-red-900/50">
                                        <label class="text-[8px] font-bold text-red-400 mb-1 block uppercase">å±æ€§æ”»æ’ƒ (+)</label>
                                        <div class="grid grid-cols-4 gap-1">
                                            <div v-for="el in elements" :key="el" class="flex flex-col items-center bg-gray-900 rounded py-0.5">
                                                <span class="text-[8px] text-gray-500">{{el[0]}}</span>
                                                <input type="number" :value="e.data.elmAtk ? e.data.elmAtk[el] : ''"
                                                       @input="setElmAtk(e, el, $event.target.value)"
                                                       class="text-[10px] h-4 w-full bg-transparent border-none p-0 text-center text-red-200">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-gray-800 p-1 rounded border border-blue-900/50">
                                        <label class="text-[8px] font-bold text-blue-400 mb-1 block uppercase">å±æ€§è€æ€§ (%)</label>
                                        <div class="grid grid-cols-4 gap-1">
                                            <div v-for="el in elements" :key="el" class="flex flex-col items-center bg-gray-900 rounded py-0.5">
                                                <span class="text-[8px] text-gray-500">{{el[0]}}</span>
                                                <input type="number" :value="e.data.elmRes ? e.data.elmRes[el] : ''"
                                                       @input="setElmRes(e, el, $event.target.value)"
                                                       class="text-[10px] h-4 w-full bg-transparent border-none p-0 text-center text-blue-200">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-800 p-1 rounded border border-purple-900/50">
                                    <label class="text-[8px] font-bold text-purple-400 mb-1 block uppercase">ç•°å¸¸ä»˜ä¸ãƒ»è€æ€§ (%)</label>
                                    <div class="grid grid-cols-1 gap-0.5 max-h-32 overflow-y-auto pr-1">
                                        <div v-for="eff in specialEffKeys" :key="eff.k" class="flex items-center justify-between gap-1 bg-gray-900 rounded px-1">
                                            <span class="text-[8px] text-gray-500 shrink-0">{{eff.n}}</span>
                                            <input type="number" :value="e.data[eff.k] || ''"
                                                   @input="setSpecial(e, eff.k, $event.target.value)"
                                                   class="text-[9px] h-4 w-8 bg-transparent border-none p-0 text-right text-purple-200">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="align-top">
                            <div class="flex flex-wrap gap-x-1 gap-y-1 bg-gray-900 p-1 rounded max-h-40 overflow-y-auto border border-gray-700">
                                <label v-for="opt in allOptionKeys" :key="opt" 
                                       class="flex items-center text-[8px] cursor-pointer shrink-0 py-0 px-1 rounded hover:bg-gray-700"
                                       :class="e.possibleOpts && e.possibleOpts.includes(opt) ? 'text-yellow-400 font-bold' : 'text-gray-500'">
                                    <input type="checkbox" :checked="e.possibleOpts && e.possibleOpts.includes(opt)"
                                           @change="toggleEquipOpt(e, opt)" class="w-2 h-2 mr-1">
                                    {{opt}}
                                </label>
                            </div>
                        </td>
                        <td class="text-center align-middle">
                            <button @click="removeList(db.EQUIP_MASTER, db.EQUIP_MASTER.indexOf(e))" class="text-red-700 hover:text-red-500 font-bold text-lg">Ã—</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="skills.js"></script>
<script src="monsters.js"></script>
<script src="characters.js"></script>
<script src="items.js"></script>
<script src="job_data.js"></script>
<script src="equips.js"></script>
<script src="database.js"></script>

<script>
const { createApp, ref, reactive, computed, watch, toRaw } = Vue;

createApp({
    setup() {
        const assignUid = (list) => {
            if(!list) return [];
            return list.map(item => {
                if(!item._uid) item._uid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                return item;
            });
        };

        const getInitialData = (key, fallbackKey) => {
            let data = [];
            if (window[key]) data = window[key];
            else if (window.DB && window.DB[fallbackKey]) data = window.DB[fallbackKey];
            return assignUid(data);
        };

        const db = reactive({
            SKILLS: getInitialData('SKILLS_DATA', 'SKILLS'),
            MONSTERS: getInitialData('MONSTERS_DATA', 'MONSTERS'),
            CHARACTERS: getInitialData('CHARACTERS_DATA', 'CHARACTERS'),
            ITEMS: getInitialData('ITEMS_DATA', 'ITEMS'),
            // EQUIP_MASTER(equips.js)ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ä¿®æ­£
            EQUIP_MASTER: getInitialData('EQUIP_MASTER', 'EQUIP_MASTER'), 
            // ä»¥ä¸‹æ—¢å­˜
            EQUIPS: window.DB ? (window.DB.EQUIPS || []) : [],
            OPT_RULES: window.DB ? (window.DB.OPT_RULES || []) : [],
            SYNERGIES: window.DB ? (window.DB.SYNERGIES || []) : [],
            MEDAL_REWARDS: window.DB ? (window.DB.MEDAL_REWARDS || []) : []
        });
        
        if(db.SKILLS.length > 0) db.SKILLS.sort((a,b) => a.id - b.id);

        const jobSkills = reactive(window.JOB_SKILLS || window.JOB_SKILLS_DATA || {});

        const currentTab = ref('skills');
        const selectedMonster = ref(null);
        const currentJob = ref(Object.keys(jobSkills)[0] || null);
        const dummyImg = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; 

        // Filter & Export States
        const skillFilter = ref('ALL');
        const showExport = reactive({ skills: false, jobs: false, monsters: false, characters: false, items: false, equips: false }); // equipsã‚’è¿½åŠ 
        const exportText = reactive({ skills: '', jobs: '', monsters: '', characters: '', items: '', equips: '' }); // equipsã‚’è¿½åŠ 

        const tabs = [
            {id:'skills', name:'ã‚¹ã‚­ãƒ«'},
            {id:'monsters', name:'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼'},
            {id:'characters', name:'ä»²é–“ã‚­ãƒ£ãƒ©'},
            {id:'items', name:'ã‚¢ã‚¤ãƒ†ãƒ '},
            {id:'jobs', name:'è·æ¥­(ç¿’å¾—)'},
            {id:'equips', name:'è£…å‚™ãƒã‚¹ã‚¿'} // â†ã“ã“ã‚’è¿½åŠ 
        ];
		// --- è£…å‚™ç·¨é›†ç”¨ã®å®šæ•°å®šç¾© ---
        const equipTypeMap = {
            'æ­¦å™¨': ['å‰£', 'æ–§', 'çŸ­å‰£', 'æ–'],
            'ç›¾': ['ç›¾', 'è…•è¼ª'],
            'é ­': ['å…œ', 'å¸½å­'],
            'ä½“': ['é§', 'ãƒ­ãƒ¼ãƒ–'],
            'è¶³': ['ãƒ–ãƒ¼ãƒ„', 'ãã¤']
        };

        const mainStatKeys = [
            {k:'atk', n:'æ”»'}, {k:'def', n:'é˜²'}, {k:'mag', n:'é­”'}, {k:'spd', n:'é€Ÿ'},
            {k:'hp', n:'HP'}, {k:'mp', n:'MP'}, {k:'finDmg', n:'ä¸ãƒ€ãƒ¡%'}, {k:'finRed', n:'è¢«ãƒ€ãƒ¡æ¸›%'},
            {k:'pierce', n:'è²«é€š%'}, {k:'doubleAction', n:'2å›è¡Œå‹•%'}, {k:'fastestAction', n:'å…ˆåˆ¶%'}
        ];

        const allOptionKeys = [
            'atk', 'mag', 'spd', 'def', 'hp', 'mp', 'finDmg', 'finRed',
            'attack_Poison', 'attack_Fear', 'attack_InstantDeath',
            'resists_Poison', 'resists_Shock', 'resists_Fear', 'resists_Debuff', 'resists_InstantDeath',
            'resists_SkillSeal', 'resists_SpellSeal', 'resists_HealSeal'
        ];
		
		// --- è£…å‚™ï¼šç‰¹æ®ŠåŠ¹æœ(çŠ¶æ…‹ç•°å¸¸ç­‰)ã®å®šç¾© ---
        const specialEffKeys = [
            {k:'attack_Poison', n:'æ¯’ä»˜ä¸'}, {k:'attack_Fear', n:'æ€¯ãˆä»˜ä¸'}, {k:'attack_InstantDeath', n:'å³æ­»ä»˜ä¸'},
            {k:'resists_Poison', n:'æ¯’è€æ€§'}, {k:'resists_Shock', n:'æ„Ÿé›»è€æ€§'}, {k:'resists_Fear', n:'æ€¯ãˆè€æ€§'},
            {k:'resists_Debuff', n:'å¼±ä½“è€æ€§'}, {k:'resists_InstantDeath', n:'å³æ­»è€æ€§'},
            {k:'resists_SkillSeal', n:'æŠ€å°è€æ€§'}, {k:'resists_SpellSeal', n:'å‘ªå°è€æ€§'}, {k:'resists_HealSeal', n:'å›å¾©å°è€æ€§'}
        ];

        // ç‰¹æ®ŠåŠ¹æœã®æ›´æ–°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const setSpecial = (e, key, val) => {
            if (val === 0 || val === "" || val === null) {
                delete e.data[key];
            } else {
                e.data[key] = Number(val);
            }
        };
		
		// --- è£…å‚™ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®çŠ¶æ…‹ ---
        const equipFilter = ref('ALL');
        const allBaseNames = computed(() => {
            return Object.values(equipTypeMap).flat();
        });

        const filteredEquips = computed(() => {
            if (equipFilter.value === 'ALL') return db.EQUIP_MASTER;
            return db.EQUIP_MASTER.filter(e => e.baseName === equipFilter.value);
        });

        // å±æ€§è€æ€§(elmRes)ã®æ›´æ–°ç”¨
        const setElmRes = (e, el, val) => {
            if (!e.data.elmRes) e.data.elmRes = {};
            if (val === 0 || val === "" || val === null) {
                delete e.data.elmRes[el];
                if (Object.keys(e.data.elmRes).length === 0) delete e.data.elmRes;
            } else {
                e.data.elmRes[el] = Number(val);
            }
        };
		
		// å±æ€§æ”»æ’ƒ(elmAtk)ã®æ›´æ–°ç”¨
        const setElmAtk = (e, el, val) => {
            if (!e.data.elmAtk) e.data.elmAtk = {};
            if (val === 0 || val === "" || val === null) {
                delete e.data.elmAtk[el];
                if (Object.keys(e.data.elmAtk).length === 0) delete e.data.elmAtk;
            } else {
                e.data.elmAtk[el] = Number(val);
            }
        };

        // ç¨®åˆ¥ãŒå¤‰ã‚ã£ãŸæ™‚ã«ãƒ™ãƒ¼ã‚¹åã‚’è‡ªå‹•è£œæ­£ã™ã‚‹
        const onEquipTypeChange = (e) => {
            const possibleBases = equipTypeMap[e.type];
            if (!possibleBases.includes(e.baseName)) {
                e.baseName = possibleBases[0];
            }
        };

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ªãƒ³ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ
        const toggleEquipOpt = (item, optKey) => {
            if (!item.possibleOpts) item.possibleOpts = [];
            const idx = item.possibleOpts.indexOf(optKey);
            if (idx > -1) item.possibleOpts.splice(idx, 1);
            else item.possibleOpts.push(optKey);
        };
		
        const skillTypes = ['ç‰©ç†','é­”æ³•','ãƒ–ãƒ¬ã‚¹','å›å¾©','è˜‡ç”Ÿ','å¼·åŒ–','å¼±ä½“','ç‰¹æ®Š','MPå›å¾©','é€šå¸¸æ”»æ’ƒ'];
        const skillTargets = ['å˜ä½“','å…¨ä½“','ãƒ©ãƒ³ãƒ€ãƒ ','è‡ªåˆ†','ãªã—'];
        const elements = ['ç«','æ°´','é¢¨','é›·','å…‰','é—‡','æ··æ²Œ'];
        
        const ailmentLabels = { 
            Poison:'æ¯’', ToxicPoison:'çŒ›æ¯’', Shock:'æ„Ÿé›»', Fear:'æ€¯ãˆ', 
            SpellSeal:'å‘ªæ–‡å°å°', SkillSeal:'æŠ€å°å°', HealSeal:'å›å¾©å°å°' 
        };
        const resistLabels = {
            Poison: 'æ¯’ãƒ»çŒ›æ¯’',
            Shock: 'æ„Ÿé›»',
            Fear: 'æ€¯ãˆ',
            Seal: 'å°å°ç³»',
            Debuff: 'å¼±ä½“åŒ–',
            InstantDeath: 'å³æ­»/å‰²åˆ'
        };

        const objToString = (obj) => {
            if(!obj) return '';
            return Object.entries(obj).map(([k,v]) => `${k}:${v}`).join(', ');
        };
        const stringToObj = (str) => {
            if(!str) return null;
            const obj = {};
            str.split(',').forEach(part => {
                const [k, v] = part.split(':');
                if(k && v) obj[k.trim()] = Number(v.trim());
            });
            return obj;
        };

        const handleImageUpload = (event, targetObj) => {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { targetObj.img = e.target.result; };
            reader.readAsDataURL(file);
        };

        // MONSTER SELECTION & AUTO-MIGRATION FOR ACTS
        const selectMonster = (m) => {
            selectedMonster.value = m;
            if (!m.elmRes) m.elmRes = {};
            if (!m.resists) m.resists = {};
            
            // Migrate acts from [id, id] to [{id, rate, condition}, ...]
            if (!m.acts) m.acts = [{id:1, rate:100, condition:0}];
            else if (m.acts.length > 0 && typeof m.acts[0] === 'number') {
                const count = m.acts.length;
                const baseRate = Math.floor(100 / count);
                const remainder = 100 % count;
                m.acts = m.acts.map((id, idx) => ({
                    id: id,
                    rate: baseRate + (idx < remainder ? 1 : 0),
                    condition: 0
                }));
            } else {
                // Ensure all existing acts objects have condition
                m.acts.forEach(a => {
                    if(a.condition === undefined) a.condition = 0;
                });
            }
        };

        const addMonsterAct = () => {
            if(selectedMonster.value) {
                selectedMonster.value.acts.push({id: 1, rate: 0, condition: 0});
            }
        };

        const recalcMonsterActs = () => {
            if(selectedMonster.value && selectedMonster.value.acts.length > 0) {
                const acts = selectedMonster.value.acts;
                const count = acts.length;
                const baseRate = Math.floor(100 / count);
                const remainder = 100 % count;
                acts.forEach((a, idx) => {
                    a.rate = baseRate + (idx < remainder ? 1 : 0);
                });
            }
        };

        const removeList = (list, index) => {
            if(confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) list.splice(index, 1);
        };
        
        const addSkill = () => {
            const newId = db.SKILLS.length > 0 ? Math.max(...db.SKILLS.map(s=>s.id)) + 1 : 1;
            db.SKILLS.unshift({ 
                id: newId, 
                _uid: Math.random().toString(36), 
                name: 'æ–°è¦ã‚¹ã‚­ãƒ«', type: 'ç‰©ç†', target: 'å˜ä½“', mp: 0, rate: 1.0, count: 1, base: 0, desc: '' 
            });
        };
        const sortSkills = () => {
            db.SKILLS.sort((a, b) => a.id - b.id);
        };
        const filteredSkills = computed(() => {
            if (skillFilter.value === 'ALL') return db.SKILLS;
            return db.SKILLS.filter(s => s.type === skillFilter.value);
        });

        // æ–°è¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¿½åŠ 
        const addMonster = () => {
            const newM = { 
                id: Date.now(), 
                _uid: Math.random().toString(36).substring(2, 11),
                rank: 1, 
                minF: 1, 
                name: 'æ–°è¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', 
                isRare: false, // â˜…åˆæœŸå€¤
                hp: 100, 
                mp: 0, 
                atk: 10, 
                def: 10, 
                spd: 10, 
                mag: 10, 
                exp: 10,   // â˜…åˆæœŸå€¤
                gold: 10,  // â˜…åˆæœŸå€¤
                acts: [{id: 1, rate: 100, condition: 0}], 
                actCount: 1, 
                img: null,
                elmRes: {}, 
                resists: {}
            };
            // è€æ€§ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            elements.forEach(el => newM.elmRes[el] = 0);
            Object.keys(resistLabels).forEach(key => newM.resists[key] = 0);

            db.MONSTERS.push(newM);
            selectMonster(newM);
        };
		
        const addCharacter = () => {
            db.CHARACTERS.push({
                id: Date.now(), 
                _uid: Math.random().toString(36),
                name: 'æ–°äºº', job: 'å†’é™ºè€…', rarity: 'N',
                hp: 100, mp: 50, atk: 10, def: 10, spd: 10, mag: 10,
                sp: 0, level: 1, lbSkills: {}, img: null,
                // â˜…ã“ã“ã‚’è¿½è¨˜
                archives: {
                    base: "",
                    lv50: "",
                    lb50: "",
                    lv100: "",
                    lb99: ""
                }
            });
        };
        const addItem = () => {
            db.ITEMS.push({ 
                id: Date.now()%10000, 
                _uid: Math.random().toString(36),
                rank: 1,
                name: 'æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ', type: 'HPå›å¾©', val: 100, price: 10, 
                desc: '', target: 'å˜ä½“' 
            });
        };
		const addEquipMaster = () => {
            db.EQUIP_MASTER.unshift({
                rank: 1, name: 'æ–°è¦è£…å‚™', type: 'æ­¦å™¨', baseName: 'å‰£',
                data: { atk: 10 }, possibleOpts: ['atk', 'mag', 'finDmg'],
                _uid: Math.random().toString(36)
            });
        };

        const addNewJob = () => {
            const name = prompt("æ–°ã—ã„è·æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(name && !jobSkills[name]) {
                jobSkills[name] = {};
                currentJob.value = name;
            }
        };
        const removeJob = (name) => {
            if(confirm(`è·æ¥­ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete jobSkills[name];
                currentJob.value = Object.keys(jobSkills)[0] || null;
            }
        };
        const updateJobSkill = (job, lv, skillId) => {
            if(skillId) jobSkills[job][lv] = Number(skillId);
            else delete jobSkills[job][lv];
        };

		// â˜…è¿½åŠ : ãƒãƒ•æ›´æ–°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const updateBuff = (skill, key, value) => {
            if (!skill.buff) skill.buff = {};
            if (value === '' || value === null || value === undefined) {
                delete skill.buff[key];
                // ç©ºãªã‚‰ buff ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è‡ªä½“ã‚’å‰Šé™¤ã—ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹
                if (Object.keys(skill.buff).length === 0) delete skill.buff;
            } else {
                skill.buff[key] = Number(value);
            }
        };

        // â˜…è¿½åŠ : ãƒ‡ãƒãƒ•æ›´æ–°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const updateDebuff = (skill, key, value) => {
            if (!skill.debuff) skill.debuff = {};
            if (value === '' || value === null || value === undefined) {
                delete skill.debuff[key];
                // ç©ºãªã‚‰ debuff ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è‡ªä½“ã‚’å‰Šé™¤ã—ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹
                if (Object.keys(skill.debuff).length === 0) delete skill.debuff;
            } else {
                skill.debuff[key] = Number(value);
            }
        };

        // --- EXPORT FUNCTION ---
        const generateExport = (list, type) => {
            let text = "";
            let sorted = [...list];
            if(sorted.length > 0 && sorted[0].id !== undefined) {
                sorted.sort((a,b) => a.id - b.id);
            }

            sorted.forEach(item => {
                let props = [];
                let priorityKeys = [];
                if (type === 'skills') priorityKeys = ['id', 'name', 'type', 'target', 'mp', 'rate', 'count', 'base', 'elm', 'desc'];
                else if (type === 'monsters') priorityKeys = ['id', 'rank', 'minF', 'name', 'hp', 'mp', 'atk', 'def', 'spd', 'mag', 'gold', 'exp', 'acts', 'actCount'];
                else if (type === 'characters') priorityKeys = ['id', 'name', 'job', 'rarity', 'hp', 'mp', 'atk', 'def', 'spd', 'mag', 'lbSkills', 'sp'];
                else if (type === 'items') priorityKeys = ['id', 'rank', 'name', 'type', 'val', 'desc', 'target', 'price'];
				else if (type === 'equips') priorityKeys = ['rank', 'name', 'type', 'baseName', 'data', 'possibleOpts']; // â†ã“ã“ã‚’è¿½åŠ 

                priorityKeys.forEach(k => {
                    if (item.hasOwnProperty(k)) {
                        let val = item[k];
                        if (k === 'acts' && type === 'monsters') {
                            if(Array.isArray(val) && val.length > 0 && typeof val[0] === 'object') {
                                // Update export format to include condition
                                const actStr = val.map(a => `{id:${a.id}, rate:${a.rate}, condition:${a.condition||0}}`).join(', ');
                                props.push(`${k}: [${actStr}]`);
                            } else {
                                props.push(`${k}:${JSON.stringify(val)}`);
                            }
                        } else {
                            if (val === null) props.push(`${k}:null`);
                            else if (typeof val === 'string') props.push(`${k}:'${val}'`);
                            else if (typeof val === 'object') props.push(`${k}:${JSON.stringify(val)}`);
                            else props.push(`${k}:${val}`);
                        }
                    }
                });

                Object.keys(item).forEach(k => {
                    if (k === '_uid' || k === 'img') return;
                    if (priorityKeys.includes(k)) return;
                    let val = item[k];
                    if (val === undefined || val === false) return;
                    if (typeof val === 'object' && val !== null && Object.keys(val).length === 0) return;

                    if (val === null) props.push(`${k}:null`);
                    else if (typeof val === 'string') props.push(`${k}:'${val}'`);
                    else if (typeof val === 'object') props.push(`${k}:${JSON.stringify(val)}`);
                    else props.push(`${k}:${val}`);
                });

                text += `{${props.join(', ')}},\n`;
            });
            return text;
        };

        const toggleExport = (type) => {
            if (showExport[type]) {
                showExport[type] = false;
            } else {
                if (type === 'jobs') {
                    let text = "";
                    for (const [job, skills] of Object.entries(jobSkills)) {
                        const levels = Object.keys(skills).sort((a,b) => Number(a) - Number(b));
                        const skillPairs = levels.map(lv => `${lv}:${skills[lv]}`).join(', ');
                        text += `'${job}': { ${skillPairs} },\n`;
                    }
                    exportText.jobs = text;
                } else {
                    let list = [];
                    if (type === 'skills') list = db.SKILLS;
                    else if (type === 'monsters') list = db.MONSTERS;
                    else if (type === 'characters') list = db.CHARACTERS;
                    else if (type === 'items') list = db.ITEMS;
                    exportText[type] = generateExport(list, type);
                }
                showExport[type] = true;
            }
        };

        const pickerOptions = {
            id: 'rpg_data_save',
            types: [{ description: 'JavaScript File', accept: {'text/javascript': ['.js']} }]
        };

        const savePartial = async (type) => {
            let content = '';
            let fileName = '';
            const clean = (arr) => JSON.parse(JSON.stringify(arr)).map(i => { delete i._uid; return i; });

            if (type === 'skills') {
                db.SKILLS.sort((a,b) => a.id - b.id);
                content = `/* skills.js */\nwindow.SKILLS_DATA = ${JSON.stringify(clean(db.SKILLS), null, 4)};\n`;
                fileName = 'skills.js';
            } else if (type === 'monsters') {
                content = `/* monsters.js */\nwindow.MONSTERS_DATA = ${JSON.stringify(clean(db.MONSTERS), null, 4)};\n`;
                fileName = 'monsters.js';
            } else if (type === 'characters') {
                content = `/* characters.js */\nwindow.CHARACTERS_DATA = ${JSON.stringify(clean(db.CHARACTERS), null, 4)};\n`;
                fileName = 'characters.js';
            } else if (type === 'items') {
                content = `/* items.js */\nwindow.ITEMS_DATA = ${JSON.stringify(clean(db.ITEMS), null, 4)};\n`;
                fileName = 'items.js';
            } else if (type === 'equips') {
                content = `/* equips.js */\nwindow.EQUIP_MASTER = ${JSON.stringify(clean(db.EQUIP_MASTER), null, 4)};\n`;
                fileName = 'equips.js';
            }

            try {
                const handle = await window.showSaveFilePicker({ ...pickerOptions, suggestedName: fileName });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                alert(`${fileName} ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            } catch(e) { console.error(e); }
        };

        const saveJobFile = async () => {
            // â˜…ä¿®æ­£: ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€Œç”Ÿã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã«å¤‰æ›ã—ã¦ã‹ã‚‰ä¿å­˜
            const rawData = toRaw(jobSkills);
            const content = `/* job_data.js */\nwindow.JOB_SKILLS_DATA = ${JSON.stringify(rawData, null, 4)};\nwindow.JOB_SKILLS = window.JOB_SKILLS_DATA;\n`;
            
            try {
                const handle = await window.showSaveFilePicker({ ...pickerOptions, suggestedName: 'job_data.js' });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                alert('job_data.js ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch(e) { console.error(e); }
        };

        const saveSystemFile = async () => {
            const content = `/* database.js */\n\n` +
                            `const CONST = ${JSON.stringify(window.CONST || {}, null, 4)};\n\n` +
                            `const DB = {\n` +
                            `    SKILLS: window.SKILLS_DATA || [],\n` +
                            `    ITEMS: window.ITEMS_DATA || [],\n` +
                            `    CHARACTERS: window.CHARACTERS_DATA || [],\n` +
                            `    MONSTERS: window.MONSTERS_DATA || [],\n` +
                            `    EQUIPS: ${JSON.stringify(db.EQUIPS || [], null, 4)},\n` +
                            `    OPT_RULES: ${JSON.stringify(db.OPT_RULES || [], null, 4)},\n` +
                            `    SYNERGIES: ${JSON.stringify(db.SYNERGIES || [], null, 4)},\n` +
                            `    MEDAL_REWARDS: ${JSON.stringify(db.MEDAL_REWARDS || [], null, 4)}\n` +
                            `};\n` +
                            `window.DB = DB;`;
            try {
                const handle = await window.showSaveFilePicker({ ...pickerOptions, suggestedName: 'database.js' });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                alert('database.js ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch(e) { console.error(e); }
        };
		
		/* setup() å†…ã«è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰ */

        // --- CSV Helper Functions ---
        
        // CSVç”¨ãƒ˜ãƒƒãƒ€ãƒ¼å®šç¾©
        const csvHeaders = {
            skills: [
                'id', 'name', 'type', 'target', 'mp', 'rate', 'count', 'base', 'elm', 'desc', 
                'priority', 'SuccessRate', 'PercentDamage', 'turn', 
                'drain', 'fix', 'IgnoreDefense', 'CureAilments', 'debuff_reset', 'buff_reset',
                'buff', 'debuff', 'HPRegen', 'MPRegen',
                'Poison', 'ToxicPoison', 'Shock', 'Fear', 'SpellSeal', 'SkillSeal', 'HealSeal'
            ],
            monsters: [
                'id', 'name', 'rank', 'minF', 'hp', 'mp', 'atk', 'def', 'spd', 'mag', 'exp', 'gold', 
                'actCount', 'acts', 'elmRes', 'resists'
            ]
        };

        // å€¤ã‚’CSVå½¢å¼ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        const escapeCSV = (val) => {
            if (val === null || val === undefined) return '';
            let str = String(val);
            if (typeof val === 'object') str = JSON.stringify(val); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯JSONåŒ–
            // ã‚«ãƒ³ãƒã€æ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¿ã€å†…éƒ¨ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        // CSVã®1è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆå¼•ç”¨ç¬¦å¯¾å¿œï¼‰
        const parseCSVLine = (line) => {
            const res = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < line.length; i++) {
                const c = line[i];
                if (inQuote) {
                    if (c === '"') {
                        if (i + 1 < line.length && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuote = false;
                        }
                    } else {
                        current += c;
                    }
                } else {
                    if (c === '"') {
                        inQuote = true;
                    } else if (c === ',') {
                        res.push(current);
                        current = '';
                    } else {
                        current += c;
                    }
                }
            }
            res.push(current);
            return res;
        };

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        const downloadCSV = (type) => {
            const list = type === 'skills' ? db.SKILLS : db.MONSTERS;
            const headers = csvHeaders[type];
            if (!list || !headers) return;

            // Header Row
            let csvContent = headers.join(',') + '\n';

            // Data Rows
            list.forEach(item => {
                const row = headers.map(key => {
                    return escapeCSV(item[key]);
                });
                csvContent += row.join(',') + '\n';
            });

            // BOMä»˜ãUTF-8ã§ä¿å­˜ (Excelæ–‡å­—åŒ–ã‘å¯¾ç­–)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒˆãƒªã‚¬ãƒ¼
        const triggerCSVImport = (type) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => handleCSVImport(e, type);
            input.click();
        };

		// --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å°‚ç”¨CSVå‡ºåŠ› (ä¿®æ­£ï¼šå¤§æ–‡å­—ã®db.CHARACTERSã‚’å‚ç…§) ---
        const downloadCharacterCSV = () => {
            const list = db.CHARACTERS; // â˜…å¤§æ–‡å­—ã«ä¿®æ­£
            if (!list || list.length === 0) {
                alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }

            const headers = [
                "id", "name", "job", "rarity", "hp", "mp", "atk", "def", "spd", "mag", //"img", 
                "resists", "lbSkills",
                "archive_base", "archive_lv50", "archive_lb50", "archive_lv100", "archive_lb99",
				"sp", "level"
            ];

            let csvContent = headers.join(",") + "\n";

            list.forEach(c => {
                const row = [
                    c.id,
                    `"${c.name}"`,
                    `"${c.job}"`,
                    `"${c.rarity}"`,
                    c.hp,
                    c.mp,
                    c.atk,
                    c.def,
                    c.spd,
                    c.mag,
                    //`"${c.img || ''}"`,
                    `"${JSON.stringify(c.resists || {}).replace(/"/g, '""')}"`,
                    `"${JSON.stringify(c.lbSkills || {}).replace(/"/g, '""')}"`,
                    `"${(c.archives?.base || '').replace(/"/g, '""')}"`,
                    `"${(c.archives?.lv50 || '').replace(/"/g, '""')}"`,
                    `"${(c.archives?.lb50 || '').replace(/"/g, '""')}"`,
                    `"${(c.archives?.lv100 || '').replace(/"/g, '""')}"`,
                    `"${(c.archives?.lb99 || '').replace(/"/g, '""')}"`,
					c.sp,
					c.level
                ];
					csvContent += row.join(",") + "\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "characters_master.csv";
            link.click();
        };


// CSVå–è¾¼å‡¦ç† (æ—¢å­˜é …ç›®ç¶­æŒç‰ˆ)
        const handleCSVImport = (e, type) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const text = event.target.result;
                    const lines = text.split(/\r\n|\n/).filter(l => l.trim() !== '');
                    if (lines.length < 2) return;

                    const headers = parseCSVLine(lines[0].trim());
                    let targetList;
                    if (type === 'skills') targetList = db.SKILLS;
                    else if (type === 'monsters') targetList = db.MONSTERS;
                    else if (type === 'characters') targetList = db.CHARACTERS;
                    else return;

                    let count = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVLine(lines[i]);
                        if (row.length !== headers.length) continue;

                        const data = {};
                        const archiveData = {}; // ä¸€æ™‚ä¿å­˜ç”¨

                        headers.forEach((key, idx) => {
                            let val = row[idx];
                            if (val === '' || val === undefined) return; // â˜…ã“ã“ãŒé‡è¦: CSVã«å€¤ãŒãªã„é …ç›®ã¯dataã«å…¥ã‚Œãªã„

                            // å‹å¤‰æ›
                            if (!isNaN(Number(val)) && val.trim() !== '') {
                                val = Number(val);
                            } else if (val.startsWith('{') || val.startsWith('[')) {
                                try { val = JSON.parse(val); } catch(e) {}
                            }

                            if (key.startsWith('archive_')) {
                                archiveData[key.replace('archive_', '')] = val;
                            } else {
                                data[key] = val;
                            }
                        });

                        if (!data.id) continue;

                        const existingIdx = targetList.findIndex(item => item.id === data.id);
                        if (existingIdx >= 0) {
                            const oldItem = targetList[existingIdx];
                            
                            // â˜…ãƒãƒ¼ã‚¸æˆ¦ç•¥: æ—¢å­˜(oldItem)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€CSVã‹ã‚‰æŠ½å‡ºã—ãŸ(data)ã§ä¸Šæ›¸ã
                            const newItem = { ...oldItem, ...data };

                            // Archives ã®æ·±ã„ãƒãƒ¼ã‚¸ (CSVã«ã‚ã‚‹è¨€èªã‚­ãƒ¼ã ã‘ä¸Šæ›¸ã)
                            if (type === 'characters' && Object.keys(archiveData).length > 0) {
                                newItem.archives = { ...(oldItem.archives || {}), ...archiveData };
                            }

                            targetList[existingIdx] = newItem;
                        } else {
                            // æ–°è¦è¿½åŠ ã®å ´åˆã¯æ§‹é€ ã‚’æ•´ãˆã‚‹
                            if (type === 'characters') data.archives = archiveData;
                            data._uid = Math.random().toString(36);
                            targetList.push(data);
                        }
                        count++;
                    }
                    alert(`${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ãƒ»è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                    targetList.sort((a, b) => a.id - b.id);

                } catch (err) {
                    console.error(err);
                    alert("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            };
            reader.readAsText(file);
            e.target.value = "";
        };

        return {
            db, jobSkills, currentTab, selectedMonster, currentJob,
            tabs, skillTypes, skillTargets, elements, dummyImg, ailmentLabels, resistLabels,
            objToString, stringToObj, handleImageUpload, selectMonster,
            removeList, addSkill, addMonster, addCharacter, addItem,
            addNewJob, removeJob, updateJobSkill,
            savePartial, saveJobFile, saveSystemFile,
            skillFilter, filteredSkills, sortSkills,
            showExport, exportText, toggleExport,
            addMonsterAct, recalcMonsterActs,
			updateBuff, updateDebuff,addEquipMaster,
			equipTypeMap, mainStatKeys, allOptionKeys, onEquipTypeChange, toggleEquipOpt, // ã“ã‚Œã‚‰ã‚’è¿½åŠ 
			equipFilter, allBaseNames, filteredEquips, setElmRes,setElmAtk, // ã“ã‚Œã‚‰ã‚’è¿½åŠ 
			specialEffKeys, setSpecial, // ã“ã‚Œã‚‰ã‚’è¿½åŠ 
			downloadCSV, triggerCSVImport, downloadCharacterCSV
        };
    }
}).mount('#app');
</script>
</body>
</html>
